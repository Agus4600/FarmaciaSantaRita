@model IEnumerable<FarmaciaSantaRita.Models.Proveedor>
@{
    ViewData["Title"] = "Proveedores";
}
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<style>
    /* --- BUSCADOR --- */
    .input-group-custom {
        border: 1px solid #ced4da;
        border-radius: 8px;
        overflow: hidden;
        background-color: white;
        max-width: 380px;
        height: 40px;
        margin: 0 auto;
        box-shadow: 0 2px 4px rgba(0,0,0,0.03);
    }

        .input-group-custom .form-control {
            border: none;
            box-shadow: none;
            padding-left: 15px;
            font-size: 0.95rem;
            color: #495057;
            height: 100%;
        }

        .input-group-custom .seccion-adorno {
            background-color: transparent !important;
            border: none;
            border-left: 1px solid #ced4da !important;
            color: #0d6efd !important;
            font-weight: 500;
            padding: 0 15px;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: default;
        }

    /* --- TABLA OPTIMIZADA CON SCROLL --- */
    .tabla-container {
        border: 1px solid #dee2e6;
        border-radius: 8px;
        background-color: white;
        overflow-y: auto;
        overflow-x: hidden;
        height: 242px;
        display: block;
    }

    #tablaProveedores {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        table-layout: fixed;
        margin-bottom: 0;
    }

        /* Encabezado Fijo (Sticky) */
        #tablaProveedores thead th {
            background-color: #007bff;
            color: white;
            position: sticky;
            top: 0;
            z-index: 10;
            height: 42px;
            font-weight: 600;
            text-align: center;
            vertical-align: middle;
            border-bottom: 2px solid #dee2e6;
            border-right: 1px solid rgba(255,255,255,0.2);
        }

        /* Celdas Compactas y Sin Puntos Suspensivos */
        #tablaProveedores th,
        #tablaProveedores td {
            padding: 4px 8px !important;
            font-size: 13px;
            height: 38px;
            vertical-align: middle;
            text-align: center;
            border-bottom: 1px solid #dee2e6;
            border-right: 1px solid #dee2e6;
            white-space: normal;
            word-wrap: break-word;
            overflow: visible;
        }

            /* Eliminar borde derecho en la última columna para estética limpia */
            #tablaProveedores td:last-child,
            #tablaProveedores th:last-child {
                border-right: none;
            }

    /* Checkbox centrado y con buen tamaño */
    .seleccionarFila {
        width: 18px;
        height: 18px;
        cursor: pointer;
        margin: 0 auto;
        display: block;
    }

    /* --- BOTONERA LATERAL --- */
    .botonera-lateral {
        width: 175px;
        display: flex;
        flex-direction: column;
        gap: 10px;
        margin-top: 30px;
    }

    .btn-accion {
        background-color: #007bff;
        color: white !important;
        border: none;
        border-radius: 10px;
        font-size: 13.5px;
        font-weight: 600;
        width: 100%;
        height: 38px;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 3px 6px rgba(0,0,0,0.15);
        transition: all 0.2s ease;
        text-decoration: none !important;
        cursor: pointer;
    }

        .btn-accion:hover {
            background-color: #0056b3;
            transform: translateY(-2px);
        }

    /* Scrollbar estético para navegadores modernos */
    .tabla-container::-webkit-scrollbar {
        width: 8px;
    }

    .tabla-container::-webkit-scrollbar-track {
        background: #f8f9fa;
        border-radius: 0 8px 8px 0;
    }

    .tabla-container::-webkit-scrollbar-thumb {
        background: #ccc;
        border-radius: 4px;
    }

        .tabla-container::-webkit-scrollbar-thumb:hover {
            background: #b3b3b3;
        }
</style>

<div class="container mt-4" style="max-width: 980px; min-height: 600px;">
    <div class="card shadow-lg p-4 h-100 d-flex flex-column" style="border-radius: 15px;">
        <div class="text-center mb-4">
            <img src="~/images/file_0000000079e461fd8636559665695d53.png" alt="Farmacia Santa Rita" style="width: 100%; max-height: 180px; object-fit: contain;">
        </div>
        <div class="d-flex justify-content-center mb-4">
            <div class="input-group input-group-custom">
                <input type="text" class="form-control" id="buscarProveedor" placeholder="Buscar proveedor..." autocomplete="off" />
                <div class="seccion-adorno"><i class="bi bi-search"></i><span>Buscar</span></div>
            </div>
        </div>
        <div class="d-flex justify-content-center flex-grow-1">
            <div class="d-flex align-items-start" style="gap: 25px; width:100%; max-width:920px;">
                <div style="flex: 1; max-width: 720px;">
                    <div class="text-center mb-2" style="font-weight:600; color:#0d6efd; border-bottom:2px solid #e9ecef; text-transform:uppercase;">LISTA DE PROVEEDORES</div>
                    <div class="tabla-container">
                        <table class="table mb-0" id="tablaProveedores">
                            <thead>
                                <tr>
                                    <th style="width: 30%;">Nombre</th>
                                    <th style="width: 20%;">Teléfono</th>
                                    <th style="width: 35%;">Correo</th>
                                    <th style="width: 15%; text-align: center;">
                                        <input type="checkbox" id="selectAllCheckbox" title="Seleccionar todos" style="width: 18px; height: 18px; cursor: pointer;" />
                                    </th>
                                </tr>
                            </thead>
                            <tbody id="cuerpoTabla"></tbody>
                        </table>
                    </div>
                </div>
                <div class="botonera-lateral">
                    <button id="btnIngresar" class="btn-accion">Ingresar</button>
                    <a asp-action="Registrar" class="btn-accion">Nuevo Proveedor</a>
                    <button id="btnEliminar" class="btn-accion">Eliminar Proveedor</button>
                    <a asp-action="Restaurar" class="btn-accion">Restaurar Proveedor</a>
                    <a asp-controller="Login" asp-action="Index" class="btn-accion">Volver</a>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        const proveedoresFull = @Html.Raw(Json.Serialize(Model));
        const cuerpo = document.getElementById("cuerpoTabla");
        const inputBusqueda = document.getElementById("buscarProveedor");

        function renderizarTabla(filtro = "") {
            const query = filtro.toLowerCase();
            const filtrados = proveedoresFull ? proveedoresFull.filter(p =>
                (p.nombreProveedor || "").toLowerCase().includes(query) ||
                (p.correoProveedor || "").toLowerCase().includes(query) ||
                (p.telefonoProveedor || "").toLowerCase().includes(query)
            ) : [];

            let htmlContent = "";
            filtrados.forEach(p => {
                htmlContent += `<tr>
                    <td class="notranslate" translate="no">
                        <span spellcheck="false">${p.nombreProveedor}</span>
                    </td>
                    <td>${p.telefonoProveedor || ''}</td>
                    <td>${p.correoProveedor || ''}</td>
                    <td>
                        <input type="checkbox" class="form-check-input seleccionarFila" value="${p.idproveedor}" />
                    </td>
                </tr>`;
            });

            cuerpo.innerHTML = htmlContent;

            // Re-adjuntar eventos a los checkboxes individuales
            document.querySelectorAll(".seleccionarFila").forEach(cb => {
                cb.onclick = function() {
                    resaltarFila(this);
                    actualizarEstadoSelectAll();
                };
            });

            // Actualizar estado del checkbox principal
            actualizarEstadoSelectAll();
        }

        function resaltarFila(checkbox) {
            checkbox.closest("tr").classList.toggle("table-primary", checkbox.checked);
        }

        function actualizarEstadoSelectAll() {
            const selectAll = document.getElementById("selectAllCheckbox");
            const checkboxes = document.querySelectorAll(".seleccionarFila");
            const checkedCount = document.querySelectorAll(".seleccionarFila:checked").length;

            if (checkedCount === 0) {
                selectAll.checked = false;
                selectAll.indeterminate = false;
            } else if (checkedCount === checkboxes.length) {
                selectAll.checked = true;
                selectAll.indeterminate = false;
            } else {
                selectAll.checked = false;
                selectAll.indeterminate = true;
            }
        }

        // Evento principal: "Seleccionar todos"
        document.getElementById("selectAllCheckbox").addEventListener("change", function () {
            const checkboxes = document.querySelectorAll(".seleccionarFila");
            checkboxes.forEach(cb => {
                cb.checked = this.checked;
                resaltarFila(cb);
            });
        });

        function mostrarAlertaAtencion(mensaje) {
            Swal.fire({
                title: '¡Atención!',
                text: mensaje,
                confirmButtonText: 'Entendido',
                confirmButtonColor: '#007bff'
            });
        }

        // --- ELIMINAR ---
        document.getElementById("btnEliminar").addEventListener("click", function () {
            const seleccionados = document.querySelectorAll(".seleccionarFila:checked");
            const cantidad = seleccionados.length;
            if (cantidad === 0) {
                mostrarAlertaAtencion("Selecciona al menos un proveedor para eliminar.");
                return;
            }
            const ids = Array.from(seleccionados).map(chk => parseInt(chk.value));
            Swal.fire({
                title: 'Confirmación de Eliminación',
                html: `¿Está seguro de que desea eliminar <b>${cantidad} proveedor(es)</b> seleccionado(s)?`,
                showCancelButton: true,
                confirmButtonColor: '#007bff',
                cancelButtonColor: '#007bff',
                confirmButtonText: 'Sí, eliminar',
                cancelButtonText: 'Cancelar'
            }).then((result) => {
                if (result.isConfirmed) {
                    fetch('/Proveedores/EliminarSeleccionados', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || '@ViewData["RequestVerificationToken"]'
                        },
                        body: JSON.stringify(ids)
                    }).then(r => {
                        if (r.ok) {
                            Swal.fire({
                                title: '¡Éxito!',
                                text: 'Operación realizada correctamente.',
                                icon: 'success',
                                confirmButtonText: 'Entendido',
                                confirmButtonColor: '#007bff'
                            }).then(() => location.reload());
                        } else {
                            Swal.fire('Error', 'No se pudo eliminar', 'error');
                        }
                    });
                }
            });
        });

        // --- INGRESAR ---
        document.getElementById("btnIngresar").addEventListener("click", function () {
            const chk = document.querySelector(".seleccionarFila:checked");
            if (!chk) return mostrarAlertaAtencion("Selecciona un proveedor para ingresar.");
            window.location.href = `/Proveedores/IngresarProveedor?idProveedorSeleccionado=${chk.value}`;
        });

        inputBusqueda.addEventListener("keyup", () => renderizarTabla(inputBusqueda.value));
        renderizarTabla();
    </script>
}