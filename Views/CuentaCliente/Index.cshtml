@model List<FarmaciaSantaRita.Models.Compra>

@{

    var currentIdProveedor = ViewData["IdProveedor"] ?? Context.Request.Query["idProveedor"].ToString() ?? "0";
    var currentVista = ViewData["vista"] ?? Context.Request.Query["vistaOrigen"].ToString() ?? "";
    var origen = Context.Request.Query["vistaOrigen"];
    var idProveedor = Context.Request.Query["idProveedor"];
    ViewData["Title"] = "CUENTAS DE CLIENTES";
    var nombreProveedor = ViewData["NombreProveedor"] as string ?? "General";
    ViewBag.IdProveedor = ViewData["IdProveedor"];
    var vista = ViewData["vista"]?.ToString();
}
@Html.AntiForgeryToken()
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
<!-- Librería SheetJS para exportar a Excel -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<style>
    /* ---------------------------------------------------- */
    /* ESTILO PARA EL ICONO DE CUENTAS DE CLIENTES          */
    /* ---------------------------------------------------- */
    .clientes-icon-container {
        display: flex;
        justify-content: center;
        width: 100%;
        color: #007bff;
    }

        .clientes-icon-container i {
            font-size: 140px; /* Tamaño imponente igual a las otras vistas */
        }

    /* Ajuste del botón Volver para esta vista específica */
    .btn-volver-estilizado {
        margin-top: 120px !important; /* Ajustado para que quepa bien en el diseño */
        background-color: #007bff;
        color: white;
        border-radius: 50px;
        padding: 10px 20px;
        font-weight: 600;
        width: 100%;
        max-width: 180px;
        text-align: center;
        box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        text-decoration: none;
        transition: all 0.3s ease;
    }

        .btn-volver-estilizado:hover {
            background-color: #0056b3;
            transform: translateY(-2px);
        }
    /* 1. CONFIGURACIÓN GENERAL */
    html, body {
        height: 100vh;
        width: 100vw;
        margin: 0;
        padding: 0;
        overflow: hidden;
        background-color: #f0f2f5;
        display: flex;
        justify-content: center;
        align-items: center;
        font-family: 'Segoe UI', system-ui, sans-serif;
    }

    .card-principal {
        width: 1300px;
        max-width: none;
        height: 610px;
        margin: 0 auto;
        transition: width 0.3s ease;
        position: relative;
        background: white;
        border-radius: 16px;
        box-shadow: 0 8px 32px rgba(0,0,0,0.08);
        padding: 30px 10px 30px 20px;
    }

    .col-md-2 {
        padding-left: 8px;
        padding-right: 10px;
    }

    .col-md-10 {
        display: flex;
        justify-content: flex-start;
    }

    .row > .col-md-2 {
        height: 100%;
        display: flex;
        flex-direction: column;
        justify-content: flex-start;
        padding-top: 5px;
        align-items: center;
        padding-right: 25px;
    }

    .btn-panel {
        background-color: #007bff;
        color: white !important;
        border: none;
        border-radius: 8px;
        padding: 8px 12px;
        font-weight: 600;
        min-width: 140px;
        width: 100%;
        max-width: 180px;
        margin-bottom: 10px;
        text-align: center;
        text-decoration: none;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 40px;
        transition: background-color 0.3s ease, transform 0.2s ease;
    }

        .btn-panel:hover {
            background-color: #0056b3 !important;
            color: white !important;
            transform: translateY(-3px) !important; /* El salto hacia arriba */
            box-shadow: 0 8px 15px rgba(0,0,0,0.2) !important; /* La sombra de profundidad */
            transition: all 0.3s
        }



        .btn-panel:active {
            transform: translateY(0) !important;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1) !important;
        }



    #logoContainer {
        min-width: 140px;
        width: 100%;
        max-width: 180px;
        height: 110px;
        margin-bottom: 10px;
        display: flex;
        justify-content: center;
        align-items: center;
        padding-left: 6px;
    }

    #farmaciaLogo {
        width: 100%;
        height: 100%;
        object-fit: contain;
    }

    .cuerpo-interactivo {
        display: flex;
        flex: none;
        overflow: hidden;
        gap: 20px;
    }

    .contenido-derecho {
        flex: none;
        display: flex;
        flex-direction: column;
        overflow: visible;
    }

    .fila-formulario {
        display: flex;
        gap: 12px;
        margin-bottom: 15px;
        align-items: flex-end;
    }

    .grupo-campo {
        flex: 1;
        display: flex;
        flex-direction: column;
    }

        .grupo-campo label {
            font-weight: 600;
            font-size: 0.8rem;
            color: #555;
            margin-bottom: 4px;
        }

    .form-control {
        border-radius: 6px;
        font-size: 0.9rem;
        padding: 7px 10px;
    }

    .ancho-fijo {
        max-width: 150px;
    }

    .ancho-mini {
        max-width: 80px;
    }

    .grupo-cliente-reducido {
        flex: 0 1 380px;
        min-width: 280px;
    }

    .seccion-tabla {
        display: flex;
        flex-direction: column;
    }

    .contenedor-scroll {
        height: calc(5 * 45px + 1px);
        overflow-y: auto;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        background: white;
    }

    .tabla-compras {
        width: 100%;
        border-collapse: collapse;
        table-layout: fixed;
    }

        .tabla-compras thead th {
            position: sticky;
            top: 0;
            background-color: #0d6efd;
            color: white;
            padding: 12px 8px;
            font-size: 0.85rem;
            z-index: 20;
            text-align: center !important;
        }

        .tabla-compras tbody td {
            height: 45px;
            padding: 0 8px;
            font-size: 0.85rem;
            border-bottom: 2px solid #dee2e6;
            vertical-align: middle;
            text-align: center;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

            .tabla-compras tbody td:first-child {
                text-align: center !important;
            }

    .sel-estado {
        border-radius: 15px;
        padding: 2px 8px;
        font-size: 0.75rem;
        font-weight: bold;
        border: 1px solid #ccc;
    }

    .pagado {
        background-color: #d1fae5;
        color: #065f46;
        border-color: #34d399;
    }

    .pendiente {
        background-color: #fff3cd;
        color: #856404;
        border-color: #ffeeba;
    }

    .btn-accion {
        background: none;
        border: none;
        font-size: 1.2rem;
        cursor: pointer;
        padding: 0 5px;
        transition: transform 0.1s;
    }

    .btn-tilde {
        color: #198754;
    }

    .btn-cruz {
        color: #dc3545;
    }

    .btn-accion:hover {
        transform: scale(1.2);
    }

    .outer-glow-error {
        box-shadow: 0 0 10px 2px rgba(220, 53, 69, 0.7) !important;
        border-color: #dc3545 !important;
    }

    .bloque-interior {
        background: white;
        border-radius: 16px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        padding: 25px;
        margin-top: 20px;
        margin-right: 20px;
        margin-bottom: 6px;
    }

    .tabla-encabezado {
        font-size: 17px;
        font-weight: 600;
        color: #0d6efd;
        text-align: left;
        margin-bottom: 0px;
        border-bottom: 2px solid #0d6efd33;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        padding-bottom: 4px;
        line-height: 1.2;
    }

    .nombre-cliente-link {
        transition: color 0.2s ease;
    }

        .nombre-cliente-link:hover {
            color: #0056b3 !important;
            text-decoration: underline !important;
        }

    /* BOTÓN "BUSCAR" COMO ADORNO - SIN EFECTOS */
    .btn-custom-adornment {
        background-color: white !important;
        color: #0d6efd !important; /* Azul igual que la lupa */
        border: none !important;
        border-left: 1px solid #dee2e6 !important; /* Solo borde izquierdo sutil */
        cursor: default !important; /* No muestra mano */
        box-shadow: none !important;
        font-weight: normal !important;
        padding: 0 15px;
    }

        /* QUITA EFECTOS HOVER COMPLETAMENTE */
        .btn-custom-adornment:hover,
        .btn-custom-adornment:focus,
        .btn-custom-adornment:active {
            background-color: white !important;
            color: #0d6efd !important;
            box-shadow: none !important;
            transform: none !important;
        }

    /* BUSCADOR ESTILO PROVEEDORES */
    .input-group-custom {
        border: 1px solid #ced4da;
        border-radius: 8px;
        overflow: hidden;
        background-color: white;
        max-width: 380px;
        height: 40px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.03);
        display: flex;
    }

        .input-group-custom .form-control {
            border: none;
            box-shadow: none;
            padding-left: 15px;
            font-size: 0.95rem;
            color: #495057;
            height: 100%;
            flex: 1;
        }

        .input-group-custom .seccion-adorno {
            background-color: transparent !important;
            border: none;
            border-left: 1px solid #ced4da !important;
            color: #0d6efd !important;
            font-weight: 500;
            padding: 0 15px;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: default;
        }
</style>

<div class="card-principal">
    <h2 class="text-center fw-bold text-primary mb-3">@ViewData["Title"]</h2>
    <div class="cuerpo-interactivo">
        <div class="row w-100 g-0">
            <div class="col-md-2 d-flex flex-column align-items-start">
                <div id="logoContainer">
                    <img src="/images/file_0000000079e461fd8636559665695d530001.png" alt="Logo" id="farmaciaLogo" />
                </div>
                <div class="clientes-icon-container">
                    <i class="bi bi-people-fill"></i>
                </div>
                @{
                    // 1. Intentar obtener el ID del proveedor (Usamos el de ViewData o Query indistintamente)
                    var idProv = (ViewData["IdProveedor"] ?? Context.Request.Query["idProveedor"].FirstOrDefault() ?? "0").ToString();

                    // 2. Intentar obtener el Nombre para que no se pierda en el título
                    var nombreProv = ViewData["NombreProveedor"]?.ToString() ?? Context.Request.Query["nombreMostrar"].ToString() ?? "Proveedor";

                    // 3. DETECCIÓN DINÁMICA DE LA VISTA DE ORIGEN
                    string vistaActual = "";
                    var actionName = ViewContext.RouteData.Values["action"]?.ToString();

                    if (actionName == "VistaDrogueriaSuiza" || actionName == "Drogueria")
                    {
                        vistaActual = "Drogueria";
                    }
                    else if (actionName == "ProveedorSecundario")
                    {
                        vistaActual = "ProveedorSecundario";
                    }
                    else
                    {
                        // Verificamos de dónde venimos mediante la URL
                        vistaActual = !string.IsNullOrEmpty(Context.Request.Query["vista"])
                        ? Context.Request.Query["vista"].ToString()
                        : !string.IsNullOrEmpty(Context.Request.Query["vistaOrigen"])
                        ? Context.Request.Query["vistaOrigen"].ToString()
                        : "ProveedorSecundario";
                    }
                }
                <a href="@Url.Action("Index", "PanelSeleccion")" class="btn-panel btn-volver-estilizado" translate="no">Volver</a>
            </div>
            <div class="col-md-10 contenido-derecho">
                <div class="bloque-interior">
                    <form id="formCompra">
                        <div class="fila-formulario">
                            <div class="grupo-campo grupo-cliente-reducido">
                                <label>Cliente</label>
                                <input type="text" id="inputNombreCliente" class="form-control" placeholder="Nombre del cliente" list="listaClientes"
                                       oninput="quitarGlow(this); this.value = this.value.replace(/[^a-zA-ZáéíóúÁÉÍÓÚñÑ\s]/g, '')" />

                                <datalist id="listaClientes">
                                    @foreach (var c in ViewBag.Clientes)
                                    {
                                        @* Solo mostramos la opción si el DNI existe y no es una cadena vacía *@
                                        if (c.dni != null && !string.IsNullOrWhiteSpace(c.dni.ToString()))
                                        {
                                            <option value="@c.nombre">@c.dni</option>
                                        }
                                    }
                                </datalist>
                            </div>

                            <!-- NUEVO CAMPO DNI (mediano, al lado) -->
                            <div class="grupo-campo ancho-fijo" style="max-width: 180px;">
                                <label>DNI</label>
                                <input type="text" id="inputDNI" class="form-control" placeholder="DNI"
                                       oninput="quitarGlow(this); this.value = this.value.replace(/[^0-9]/g, '')" maxlength="8" />
                            </div>

                            <div class="grupo-campo ancho-fijo">
                                <label>Teléfono</label>
                                <input type="text" id="inputTelefono" class="form-control" placeholder="3865XXXXXX"
                                       oninput="quitarGlow(this); this.value = this.value.replace(/[^0-9]/g, '')" />
                            </div>

                            <div class="grupo-campo">
                                <label>Dirección</label>
                                <input type="text" id="inputDireccion" class="form-control" placeholder="Ej: Domicilio, Localidad" oninput="quitarGlow(this)" />
                            </div>
                        </div>
                        <div class="fila-formulario">
                            <div class="grupo-campo">
                                <label>Producto</label>
                                <input type="text" id="inputProducto" class="form-control" placeholder="Nombre del producto" list="listaProductos" oninput="quitarGlow(this)" />
                                <datalist id="listaProductos">
                                    @foreach (var p in ViewBag.Productos)
                                    {
                                        <option value="@p.Nombre"></option>
                                    }
                                </datalist>
                            </div>
                            <div class="grupo-campo ancho-mini">
                                <label>Cant.</label>
                                <input type="number"
                                       id="inputCantidad"
                                       class="form-control"
                                       value="1"
                                       min="1"
                                       step="1"
                                       oninput="corregirCantidad(this)" />
                            </div>
                            <div class="grupo-campo ancho-fijo">
                                <label>Precio Unit.</label>
                                <input type="text"
                                       id="inputPrecio"
                                       class="form-control"
                                       placeholder="0,00"
                                       oninput="corregirPrecioInput(this)"
                                       autocomplete="off" />
                            </div>
                            <div class="grupo-campo ancho-fijo">
                                <label>Fecha</label>
                                <input type="date" id="inputFecha" class="form-control" value="@DateTime.Now.ToString("yyyy-MM-dd")" oninput="quitarGlow(this)" />
                            </div>
                            <button type="button" class="btn btn-success" style="height: 38px; width: 45px; margin-right: 10px;" onclick="agregarProductoATabla()">
                                <i class="bi bi-plus-lg"></i>
                            </button>
                            <button type="button" class="btn btn-success" style="height: 38px; padding: 0 15px;" onclick="exportarAExcel()">
                                <i class="bi bi-file-earmark-excel"></i> Excel
                            </button>
                        </div>
                    </form>
                    <div class="seccion-tabla">
                        <!-- TÍTULO + BUSCADOR – ESPACIO PERFECTO COMO EN LA IMAGEN -->
                        <div class="d-flex justify-content-between align-items-end mb-2">
                            <!-- mb-2 = ~8px -->
                            <div class="flex-grow-1 me-4">
                                <div class="tabla-encabezado" style="margin-bottom: 6px;">
                                    LISTADO DE COMPRAS REGISTRADAS
                                </div>
                            </div>
                            <div class="input-group-custom">
                                <input type="text"
                                       id="buscadorCliente"
                                       class="form-control"
                                       placeholder="Buscar cliente"
                                       aria-label="Buscar cliente"
                                       autocomplete="off" />
                                <div class="seccion-adorno">
                                    <i class="bi bi-search"></i>
                                    <span>Buscar</span>
                                </div>
                            </div>
                        </div>
                        <div class="contenedor-scroll" style="margin-top: 0;">
                            <table class="tabla-compras" id="tablaCompras">
                                <thead>
                                    <!-- FILA FIJA CON TOTAL DEUDA Y BOTONES (siempre visible) -->
                                    <tr style="background: #e3f2fd; font-size: 1.1rem; font-weight: bold;">
                                        <td colspan="8" class="text-center py-3">
                                            Deuda total pendiente:
                                            <span id="totalDeuda" class="text-danger ms-2">$0,00</span>

                                            Monto a pagar:
                                            <input type="number" id="montoParcial" class="form-control d-inline-block mx-2"
                                                   style="width: 140px; height: 32px; vertical-align: middle;" min="0" step="0.01" placeholder="Ej: 5000" />

                                            <button id="btnPagarParcial" class="btn btn-primary btn-sm px-3 py-1">Pagar Parcial</button>
                                            <button id="btnPagarTodo" class="btn btn-success btn-sm px-3 py-1 ms-2">Pagar Todo</button>
                                        </td>
                                    </tr>

                                    <!-- Encabezados normales de la tabla -->
                                    <tr>
                                        <th style="width: 20%;">Nombre</th>
                                        <th style="width: 15%;">Producto</th>
                                        <th style="width: 7%;">Cant.</th>
                                        <th style="width: 12%;">Precio U.</th>
                                        <th style="width: 12%;">Fecha</th>
                                        <th style="width: 12%;">Total</th>
                                        <th style="width: 14%;">Estado</th>
                                        <th style="width: 10%;">Acción</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var compra in Model)
                                    {
                                        var nombreCliente = compra.IdclienteNavigation?.NombreCliente ?? "Desconocido";
                                        var telefonoCliente = compra.IdclienteNavigation?.TelefonoCliente ?? "Sin teléfono";
                                        var direccionCliente = compra.IdclienteNavigation?.DireccionCliente ?? "Sin dirección";
                                        var dniCliente = compra.IdclienteNavigation?.DNI ?? "Sin DNI";

                                        // Tomamos la PRIMERA línea de compra (asumiendo que por ahora hay solo una por compra)
                                        var linea = compra.LineaDeCompras?.FirstOrDefault();

                                        <tr data-id="@compra.Idcompras"
                                            data-idcliente="@compra.Idcliente"
                                            data-nombre="@(nombreCliente.ToLower())"
                                            data-telefono="@telefonoCliente"
                                            data-direccion="@direccionCliente"
                                            data-dni="@dniCliente">
                                            <td class="fw-bold">
                                                <span class="nombre-cliente-link"
                                                      style="cursor: pointer; text-decoration: underline; color: #007bff;">
                                                    @nombreCliente
                                                </span>
                                            </td>
                                            <td>@(linea?.IdproductoNavigation?.NombreProducto ?? "Sin producto")</td>
                                            <td contenteditable="true" class="edit-cant">@(linea?.Cantidad ?? 0)</td>
                                            <td contenteditable="true" class="edit-precio"
                                                data-precio-raw="@(linea?.IdproductoNavigation?.PrecioUnitario ?? 0)">
                                                $@string.Format("{0:N2}", linea?.IdproductoNavigation?.PrecioUnitario ?? 0)
                                                .Replace(",", "X").Replace(".", ",").Replace("X", ".")
                                            </td>
                                            <td>@compra.FechaCompra.ToString("dd/MM/yyyy")</td>
                                            <td class="text-primary fw-bold">$ @compra.MontoCompra.ToString("N2")</td>
                                            <td>
                                                @{
                                                    var pg = compra.EstadoDePago == "pagado";
                                                }
                                                <select class="sel-estado @(pg ? "pagado" : "pendiente")" onchange="actualizarEstadoStyle(this)">
                                                    <option value="pendiente" selected="@(!pg)">Pendiente</option>
                                                    <option value="pagado" selected="@pg">Pagado</option>
                                                </select>
                                            </td>
                                            <td>
                                                <button class="btn-accion btn-tilde" title="Actualizar" onclick="enviarActualizacion(this)">
                                                    <i class="bi bi-check-circle-fill"></i>
                                                </button>
                                                <button class="btn-accion btn-cruz" title="Eliminar" onclick="eliminarFila(this)">
                                                    <i class="bi bi-x-circle-fill"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    }
                                    @for (int i = Model.Count; i < 5; i++)
                                    {
                                        <tr class="fila-vacia">
                                            <td>&nbsp;</td>
                                            <td>&nbsp;</td>
                                            <td>&nbsp;</td>
                                            <td>&nbsp;</td>
                                            <td>&nbsp;</td>
                                            <td>&nbsp;</td>
                                            <td>&nbsp;</td>
                                            <td>&nbsp;</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.jsdelivr.net/npm/exceljs/dist/exceljs.min.js"></script>
<script>
        document.addEventListener("DOMContentLoaded", function () {
        const filas = document.querySelectorAll('#tablaCompras tbody tr:not(.fila-vacia)');
        if (filas.length > 0) {
            // Si agregaste data-idcliente en las filas, podés usarlo
            const idCliente = filas[0].dataset.idcliente || null;
            if (idCliente) actualizarTotalDeuda(idCliente);
            }
        });

    const token = document.querySelector('input[name="__RequestVerificationToken"]').value;

    // Lista de clientes existentes para detectar si es nuevo o registrado
    const clientesExistentes = [
        @foreach (var c in ViewBag.Clientes)
        {
                var nombreLimpio = (c.nombre ?? "").Trim().ToLowerInvariant();
                <text>'@nombreLimpio',</text>
        }
    ];

    function quitarGlow(input) {
        input.classList.remove('outer-glow-error');
    }

    function aplicarGlowErrores() {
        const camposObligatorios = ['inputNombreCliente', 'inputProducto', 'inputCantidad', 'inputPrecio', 'inputFecha'];
        camposObligatorios.forEach(id => {
            const el = document.getElementById(id);
            if (el && !el.value.trim()) {
                el.classList.add('outer-glow-error');
            } else if (el) {
                el.classList.remove('outer-glow-error');
            }
        });
    }

    function corregirCantidad(input) {
        let valor = parseInt(input.value);
        if (isNaN(valor) || valor < 1) input.value = 1;
        quitarGlow(input);
    }

    function corregirPrecioInput(input) {
        let valor = input.value.trim();
        if (valor === '') return quitarGlow(input);
        valor = valor.replace(/[^0-9,.]/g, '').replace(',', '.');
        input.value = valor;
        quitarGlow(input);
    }

    function formatearPrecioEnTabla(td) {
        if (!td) return;
        const raw = parseFloat(td.dataset.precioRaw || td.innerText.replace(/[^\d.]/g, '') || 0);
        if (isNaN(raw)) {
            td.innerText = '$ 0,00';
            td.dataset.precioRaw = '0';
            return;
        }
        td.innerText = '$ ' + raw.toLocaleString('es-AR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        td.dataset.precioRaw = raw.toFixed(2);
    }

    async function agregarProductoATabla() {
        const n = document.getElementById('inputNombreCliente').value.trim();
        const dni = document.getElementById('inputDNI').value.trim();
        const t = document.getElementById('inputTelefono').value.trim();
        const d = document.getElementById('inputDireccion').value.trim();
        const p = document.getElementById('inputProducto').value.trim();
        const c = parseInt(document.getElementById('inputCantidad').value);
        const u = parseFloat(document.getElementById('inputPrecio').value);
        const f = document.getElementById('inputFecha').value;

        // Validación básica: campos obligatorios siempre
        if (!n || !p || isNaN(c) || isNaN(u) || !f) {
            aplicarGlowErrores();
            Swal.fire('Error', 'Complete: Cliente, Producto, Cantidad, Precio y Fecha', 'warning');
            return;
        }

        // Solo si es cliente NUEVO → obligamos DNI
        const nombreNorm = n.toLowerCase();
        const esClienteNuevo = !clientesExistentes.includes(nombreNorm);
        if (esClienteNuevo && !dni) {
            document.getElementById('inputDNI').classList.add('outer-glow-error');
            Swal.fire('Error', 'Cliente nuevo: ingrese DNI', 'warning');
            return;
        }

        try {
            const response = await fetch('/CuentaCliente/GuardarNuevaCompra', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'RequestVerificationToken': token
                },
                body: JSON.stringify({
                    nombre: n,
                    dni: dni || null,         // Enviamos null si no hay DNI (cliente existente)
                    producto: p,
                    cantidad: c,
                    precio: u,
                    estado: "pendiente",
                    telefono: t || null,
                    direccion: d || null,
                    fecha: f
                })
            });

            if (!response.ok) throw new Error(`Error ${response.status}`);

            const result = await response.json();

            if (result.success) {
                location.reload();  // Recarga y muestra la nueva compra
            } else {
                Swal.fire('Error', result.message || 'No se pudo guardar', 'error');
            }
        } catch (error) {
            console.error(error);
            Swal.fire('Error', 'No se pudo conectar con el servidor', 'error');
        }
    }





    





        async function enviarActualizacion(btn) {
        const tr = btn.closest('tr');
        const id = tr.dataset.id;

        // Capturamos los valores actuales de la fila
        const cant = tr.querySelector('.edit-cant').innerText.trim();
        // Limpiamos el precio de símbolos y espacios
        const precioTexto = tr.querySelector('.edit-precio').innerText.replace('$ ', '').replace(',', '.').trim();
        const precio = parseFloat(precioTexto);

        // CAPTURAMOS EL ESTADO DEL SELECT
        const estado = tr.querySelector('.sel-estado').value;

        if (!id) return;

        try {
            const res = await fetch('/CuentaCliente/ActualizarCompra', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'RequestVerificationToken': token
                },
                body: JSON.stringify({
                    idCompra: parseInt(id),
                    cantidad: parseInt(cant),
                    precio: precio,
                    estado: estado
                })
            });

            const result = await res.json();

            if (result.success) {
                Swal.fire({
                    icon: 'success',
                    title: 'Registro Actualizado',
                    text: 'Los cambios se guardaron correctamente',
                    showConfirmButton: false,
                    timer: 1500
                });
                // Recargamos para refrescar totales si es necesario
                setTimeout(() => location.reload(), 1600);
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: result.message || 'No se pudo actualizar'
                });
            }
        } catch (e) {
            Swal.fire({
                icon: 'error',
                title: 'Error de conexión',
                text: 'No se pudo contactar con el servidor'
            });
        }
    }

    // Esta función solo cambia el color visual del select al hacer clic
    function actualizarEstadoStyle(sel) {
        sel.className = 'sel-estado ' + sel.value;
    }







         function exportarAExcel() {
        const tabla = document.getElementById('tablaCompras');
        const filasDatos = tabla.querySelectorAll('tbody tr:not(.fila-vacia)');

        if (filasDatos.length === 0) {
            Swal.fire({
                icon: 'info',
                title: 'Sin datos',
                text: 'No hay registros para exportar.',
                confirmButtonColor: '#007bff'
            });
            return;
        }

        // Preparar datos y contar estados
        const datosTabla = [];
        let pendientes = 0;
        let pagados = 0;

        filasDatos.forEach(fila => {
            const celdas = fila.querySelectorAll('td');
            const row = [];
            row.push(celdas[0].querySelector('.nombre-cliente-link')?.innerText.trim() || '');
            row.push(celdas[1].innerText.trim());
            row.push(celdas[2].innerText.trim());
            row.push(celdas[3].innerText.trim());
            row.push(celdas[4].innerText.trim());
            row.push(celdas[5].innerText.trim());

            const estadoSelect = celdas[6].querySelector('.sel-estado');
            const estado = (estadoSelect?.value || 'Pendiente').toLowerCase();
            row.push(estadoSelect?.value || 'Pendiente');

            if (estado === 'pendiente') pendientes++;
            else if (estado === 'pagado') pagados++;

            datosTabla.push(row);
        });

        // Crear workbook
        const workbook = new ExcelJS.Workbook();
        const worksheet = workbook.addWorksheet('COMPRAS REGISTRADAS');

        // Título
        worksheet.addRow(['LISTADO DE COMPRAS REGISTRADAS']);
        worksheet.mergeCells('A1:G1');
        const titleCell = worksheet.getCell('A1');
        titleCell.value = 'LISTADO DE COMPRAS REGISTRADAS';
        titleCell.font = { size: 14, bold: true };
        titleCell.alignment = { horizontal: 'center', vertical: 'middle' };
        titleCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFF5F5DC' } };
        titleCell.border = { top: { style: 'thin' }, left: { style: 'thin' }, bottom: { style: 'thin' }, right: { style: 'thin' } };

        // Encabezados
        const headers = ['Nombre', 'Producto', 'Cant.', 'Precio U.', 'Fecha', 'Total', 'Estado'];
        const headerRow = worksheet.addRow(headers);
        headerRow.eachCell((cell) => {
            cell.font = { bold: true };
            cell.alignment = { horizontal: 'center', vertical: 'middle' };
            cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFFFC080' } };
            cell.border = { top: { style: 'thin' }, left: { style: 'thin' }, bottom: { style: 'thin' }, right: { style: 'thin' } };
        });

        // Datos con filas alternadas
        datosTabla.forEach((rowData, index) => {
            const row = worksheet.addRow(rowData);
            const colorFondo = index % 2 === 0 ? 'FFDDEEFF' : 'FFCCFFFF';
            row.eachCell((cell, colNumber) => {
                if (colNumber === 4) { // Precio Unitario
                    cell.numFmt = '"$" #,##0.00';
                }
                if (colNumber === 5) { // Fecha
                    cell.numFmt = 'DD/MM/YYYY';
                }
                if (colNumber === 6) { // Total
                    cell.numFmt = '"$" #,##0.00';
                }
                cell.alignment = { horizontal: 'center', vertical: 'middle' };
                cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: colorFondo } };
                cell.border = { top: { style: 'thin' }, left: { style: 'thin' }, bottom: { style: 'thin' }, right: { style: 'thin' } };
            });
        });
        

        // RESUMEN EN I3:K5 (exactamente como pediste)
        const resumenStartRow = 3; // Fila 3

        // Título "Resumen Estado" en I3:K3
        worksheet.mergeCells(`I${resumenStartRow}:K${resumenStartRow}`);
        const resumenTitle = worksheet.getCell(`I${resumenStartRow}`);
        resumenTitle.value = 'Resumen Estado';
        resumenTitle.font = { bold: true, color: { argb: 'FFFFFFFF' } };
        resumenTitle.alignment = { horizontal: 'center', vertical: 'middle' };
        resumenTitle.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF33CC99' } };
        ['I', 'J', 'K'].forEach(col => worksheet.getCell(`${col}${resumenStartRow}`).border = { top: { style: 'thin' }, left: { style: 'thin' }, bottom: { style: 'thin' }, right: { style: 'thin' } });

        // Pendientes en I4:K4
        worksheet.mergeCells(`I${resumenStartRow + 1}:J${resumenStartRow + 1}`);
        const pendientesLabel = worksheet.getCell(`I${resumenStartRow + 1}`);
        pendientesLabel.value = 'Pendientes:';
        pendientesLabel.font = { bold: true, color: { argb: 'FFFFFFFF' } };
        pendientesLabel.alignment = { horizontal: 'center', vertical: 'middle' };
        pendientesLabel.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF33CC99' } };

        const pendientesValue = worksheet.getCell(`K${resumenStartRow + 1}`);
        pendientesValue.value = pendientes;
        pendientesValue.font = { bold: true, color: { argb: 'FFFFFFFF' } };
        pendientesValue.alignment = { horizontal: 'center', vertical: 'middle' };
        pendientesValue.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF33CC99' } };
        ['I', 'J', 'K'].forEach(col => worksheet.getCell(`${col}${resumenStartRow + 1}`).border = { top: { style: 'thin' }, left: { style: 'thin' }, bottom: { style: 'thin' }, right: { style: 'thin' } });

        // Pagados en I5:K5
        worksheet.mergeCells(`I${resumenStartRow + 2}:J${resumenStartRow + 2}`);
        const pagadosLabel = worksheet.getCell(`I${resumenStartRow + 2}`);
        pagadosLabel.value = 'Pagados:';
        pagadosLabel.font = { bold: true, color: { argb: 'FFFFFFFF' } };
        pagadosLabel.alignment = { horizontal: 'center', vertical: 'middle' };
        pagadosLabel.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF33CC99' } };

        const pagadosValue = worksheet.getCell(`K${resumenStartRow + 2}`);
        pagadosValue.value = pagados;
        pagadosValue.font = { bold: true, color: { argb: 'FFFFFFFF' } };
        pagadosValue.alignment = { horizontal: 'center', vertical: 'middle' };
        pagadosValue.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF33CC99' } };
        ['I', 'J', 'K'].forEach(col => worksheet.getCell(`${col}${resumenStartRow + 2}`).border = { top: { style: 'thin' }, left: { style: 'thin' }, bottom: { style: 'thin' }, right: { style: 'thin' } });

        // AUTOAJUSTE COMPACTO
        worksheet.columns.forEach((column, colIndex) => {
            let maxLength = 8;
            for (let rowNum = 3; rowNum <= worksheet.rowCount; rowNum++) {
                const cell = worksheet.getCell(rowNum, colIndex + 1);
                const text = cell.value ? cell.value.toString() : '';
                const length = text.length;
                if (length > maxLength) maxLength = length;
            }
            column.width = maxLength + (colIndex === 0 ? 4 : 2);
        });

        // Nombre del archivo
        const now = new Date();
        const datePart = now.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' }).replace(/\//g, '-');
        const timePart = now.getHours().toString().padStart(2, '0') + '∶' + now.getMinutes().toString().padStart(2, '0');
        const fileName = `Reporte Compras ${datePart} ${timePart}.xlsx`;

        // Descargar
        workbook.xlsx.writeBuffer().then(buffer => {
            const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = fileName;
            link.click();
        }).catch(err => {
            console.error('Error al generar Excel:', err);
            Swal.fire('Error', 'No se pudo generar el archivo Excel.', 'error');
        });
    }








        // BUSCADOR PREDICTIVO EN TIEMPO REAL
    document.getElementById('buscadorCliente').addEventListener('input', function() {
        const filtro = this.value.toLowerCase().trim();
        const filas = document.querySelectorAll('#tablaCompras tbody tr');

        filas.forEach(fila => {
            const nombre = fila.dataset.nombre || '';
            if (filtro === '' || nombre.includes(filtro)) {
                fila.style.display = '';
            } else {
                fila.style.display = 'none';
            }
        });
    });



    document.querySelectorAll('.nombre-cliente-link').forEach(link => {
        link.addEventListener('click', function() {
            const tr = this.closest('tr');
            const nombre = tr.querySelector('.nombre-cliente-link').innerText.trim();
            const telefono = tr.dataset.telefono || 'Sin teléfono';
            const direccion = tr.dataset.direccion || 'Sin dirección';
            const dni = tr.dataset.dni || 'Sin DNI';

            Swal.fire({
                title: `<strong>${nombre}</strong>`,
                html: `
                    <p><strong>DNI:</strong> ${dni}</p>
                    <p><strong>Teléfono:</strong> ${telefono}</p>
                    <p><strong>Dirección:</strong> ${direccion}</p>
                `,
                confirmButtonText: 'Entendido',
                confirmButtonColor: '#007bff',
                width: '400px'
            });
        });
    });

        async function eliminarFila(btn) {
        const tr = btn.closest('tr');
        const id = tr.dataset.id;

        if (!id) {
            // Si no tiene ID (fila vacía), solo la elimina del DOM
            tr.remove();
            return;
        }

        const confirmacion = await Swal.fire({
            title: '¿Eliminar compra?',
            text: 'Esta acción no se puede deshacer',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#dc3545',
            confirmButtonText: 'Sí, eliminar',
            cancelButtonText: 'Cancelar'
        });

        if (!confirmacion.isConfirmed) return;

        try {
            const res = await fetch(`/CuentaCliente/EliminarCompra?id=${id}`, {
                method: 'POST',
                headers: { 'RequestVerificationToken': token }
            });

            const result = await res.json();

            if (result.success) {
                tr.remove();
                Swal.fire({
                    icon: 'success',
                    title: 'Eliminado',
                    text: 'La compra ha sido borrada permanentemente',
                    timer: 1500,
                    showConfirmButton: false
                });
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: result.message || 'No se pudo eliminar'
                });
            }
        } catch (e) {
            Swal.fire({
                icon: 'error',
                title: 'Error de conexión',
                text: 'No se pudo contactar con el servidor'
            });
        }
    }







        // Formatear todos los precios al cargar la página
    document.addEventListener("DOMContentLoaded", function () {
        document.querySelectorAll('.edit-precio').forEach(td => {
            formatearPrecioEnTabla(td);
        });
    });

    // Cuando terminan de editar el precio (al hacer blur o enter)
    document.querySelector('#tablaCompras').addEventListener('blur', function(e) {
        if (e.target.classList.contains('edit-precio')) {
            formatearPrecioEnTabla(e.target);
        }
    }, true);

    // También al presionar Enter
    document.querySelector('#tablaCompras').addEventListener('keydown', function(e) {
        if (e.target.classList.contains('edit-precio') && e.key === 'Enter') {
            e.preventDefault();
            formatearPrecioEnTabla(e.target);
            e.target.blur();
        }
    });
</script>