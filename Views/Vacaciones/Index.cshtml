@model IEnumerable<FarmaciaSantaRita.Models.Vacacion>

@using System.Security.Claims

@{

    ViewData["Title"] = "Vacaciones de Empleados";

    var idProv = (ViewData["IdProveedor"] ?? Context.Request.Query["idProveedor"].FirstOrDefault() ?? "0").ToString();

    string rolUsuario = User.FindFirstValue(ClaimTypes.Role);

    bool esJefe = rolUsuario == "Jefe/a";

    string claseVisualDisabled = esJefe ? "" : "contenedor-deshabilitado";

    string disabledAttr = esJefe ? "" : "disabled=\"disabled\"";

    string vistaActual = Context.Request.Query["vista"].ToString()

                         ?? Context.Request.Query["vistaOrigen"].ToString()

                         ?? Context.Request.Query["origen"].ToString()

                         ?? ViewData["vista"]?.ToString()

                         ?? "ProveedorSecundario";

}

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
    /* --- ESTILO PARA EL ICONO (IGUAL A INASISTENCIAS) --- */
    .empleado-icon-container {
        display: flex;
        justify-content: center;
        width: 100%;
        color: #007bff;
        margin-bottom: 10px;
    }

        .empleado-icon-container i {
            font-size: 140px;
        }

    /* --- CONTENEDOR DE BOTONES INFERIORES --- */
    .botones-inferiores-container {
        margin-top: 80px !important;
        width: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    /* Estilo Píldora unificado */
    .col-md-2 a.btn-pildora {
        background-color: #007bff;
        color: white !important;
        border-radius: 50px;
        padding: 10px 20px;
        font-weight: 600;
        text-align: center;
        text-decoration: none;
        display: flex;
        justify-content: center;
        align-items: center;
        width: 100%;
        max-width: 180px;
        height: 45px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        transition: all 0.3s ease;
        border: none;
    }

        .col-md-2 a.btn-pildora:hover {
            background-color: #0056b3 !important;
            transform: translateY(-3px) !important;
            box-shadow: 0 8px 15px rgba(0,0,0,0.2) !important;
        }


    .fila-seleccionada {
        background-color: #cce5ff !important; /* Azul claro como en Inasistencias */
    }

    /* Prioridad visual: Swal encima del datepicker y todo lo demás */
    .swal2-container, .swal2-popup {
        z-index: 99999 !important;
    }

    /* Bajar ligeramente el datepicker si interfiere */
    .daterangepicker {
        z-index: 1050 !important;
    }

    /* Nombre del empleado siempre subrayado, color azul, cursor pointer */

    #tablaVacaciones tbody td.empleado-clickable {

        font-weight: bold !important;

        color: #007bff !important;

        cursor: pointer;

        text-decoration: underline !important; /* ← subrayado permanente */

        text-decoration-color: #007bff !important; /* color del subrayado = azul */

        text-underline-offset: 2px; /* opcional: un poco más separado del texto */

    }

        /* Hover: solo cambia intensidad del color (subrayado se mantiene) */

        #tablaVacaciones tbody td.empleado-clickable:hover {

            color: #0056b3 !important; /* azul más oscuro */

            text-decoration: underline !important; /* se mantiene */

        }

    /* Tus estilos existentes (los mismos de Inasistencias) */

    .contenedor-deshabilitado {

        pointer-events: none;

        opacity: 0.6;

        filter: grayscale(40%);

    }

    .card-principal {

        width: 100%;

        max-width: 1200px;

        margin: 0 auto;

        transition: width 0.3s ease;

        position: relative;

        border-radius: 16px;

    }

    .bloque-principal {

        display: flex;

        flex-direction: column;

        flex-wrap: nowrap;

        align-items: flex-start;

        background: #fff;

        border-radius: 12px;

        box-shadow: 0 2px 10px rgba(0,0,0,0.1);

        padding: 65px 20px 20px 20px;

        width: 100%;

        max-width: 1100px;

        margin: 0 auto;

        max-height: 480px;

        overflow: visible;

        position: relative;

    }

    .row > .col-md-2 {

        margin-top: -115px;

        height: 420px;

        display: flex;

        top: 0;

        z-index: 10;

        position: sticky;

        flex-direction: column;

        justify-content: flex-start;

        align-items: center !important;

        padding-top: 50px;

    }

    .col-md-2 a.btn {

        background-color: #007bff;

        color: white;

        border: none;

        border-radius: 8px;

        padding: 8px 12px;

        font-weight: 600;

        height: 40px;

        min-width: 140px;

        width: 100%;

        max-width: 180px;

        display: flex;

        margin-bottom: 10px;

        text-align: center;

        justify-content: center;

        align-items: center;

        text-decoration: none;

        transition: all 0.3s ease;

    }

        .col-md-2 a.btn:hover {

            background-color: #0056b3 !important;

            transform: translateY(-3px) !important;

            box-shadow: 0 8px 15px rgba(0,0,0,0.2) !important;

        }

    #logoContainer {

        min-width: 140px;

        width: 100%;

        max-width: 180px;

        height: 200px;

        margin-bottom: 10px;

        display: flex;

        justify-content: center;

        align-items: center;

        background-color: transparent;

        border-radius: 8px;

        border: none;

        padding: 5px;

    }

    #farmaciaLogo {

        width: 100%;

        height: 100%;

        object-fit: contain;

    }

    .groupbox-filtro {

        border: 1px solid #0d6efd;

        border-radius: 8px;

        padding: 8px 14px 10px 14px;

        background-color: #f7f9fc;

        position: absolute;

        top: 20px;

        right: 20px; /* Mantiene el margen derecho */

        left: 580px; /* ← Extiende hacia la izquierda hasta cerca de los campos */

        z-index: 1000;

        width: auto; /* Se ajusta entre left y right */

        max-width: none;

        box-shadow: 0 1px 5px rgba(0, 0, 0, 0.1);

        height: auto; /* Permite que se estire */

        min-height: 200px; /* Altura mínima para que se vea bien */

    }

        .groupbox-filtro legend {

            font-size: 15px;

            font-weight: 600;

            color: #0d6efd;

            width: auto;

            padding: 0 6px;

            margin-left: 5px;

        }

    .campos-centrados {

        display: flex;

        justify-content: flex-start;

        align-items: flex-end;

        width: 100%;

        gap: 15px;

        margin-bottom: 25px !important;

        flex-wrap: wrap;

    }

    .campo {

        display: flex;

        flex-direction: column;

        align-items: flex-start;

    }

        .campo label {

            font-weight: 600;

            margin-bottom: 5px;

        }

        .campo input, .campo select {

            padding: 6px 8px;

            border-radius: 6px;

            border: 1px solid #ccc;

            box-sizing: border-box;

            width: 100%;

            height: 38px;

            text-align: center;

        }

        .campo select {

            text-align-last: center;

        }

    .contenedor-tablas-botones {

        display: flex;

        flex-direction: row;

        justify-content: flex-start;

        align-items: stretch;

        width: 100%;

        max-width: 1100px;

        margin: 0;

        gap: 35px;

        flex-wrap: nowrap;

        height: auto;

    }

    .table-wrapper {

        flex: 0 0 740px;

        max-width: 740px;

    }

    .table-responsive {

        height: 180px;

        max-height: 180px;

        overflow-y: auto;

        overflow-x: hidden;

        border: 1px solid #dee2e6;

    }

    .table {

        table-layout: fixed;

        width: 100%;

    }

        .table th, .table td {

            text-align: center;

            vertical-align: middle;

            padding: 4px 8px;

            border: 1px solid #dee2e6;

            white-space: nowrap;

            overflow: hidden;

            text-overflow: ellipsis;

        }

    #tablaVacaciones th:nth-child(1), #tablaVacaciones td:nth-child(1) {

        width: 25%;

    }

    /* Empleado */

    #tablaVacaciones th:nth-child(2), #tablaVacaciones td:nth-child(2) {

        width: 15%;

    }

    /* Días */

    #tablaVacaciones th:nth-child(3), #tablaVacaciones td:nth-child(3) {

        width: 30%;

        white-space: nowrap; /* evita saltos de línea */

    }

    #tablaVacaciones th:nth-child(5), #tablaVacaciones td:nth-child(5) {

        width: 15%;

    }

    /* Días Favor */

    #tablaVacaciones th:nth-child(6), #tablaVacaciones td:nth-child(6) {

        width: 5%;

    }

    #tablaVacaciones td, #tablaVacaciones th {

        height: 32px; /* ← Reducida a 32px → filas más cortas y elegantes */

        padding: 2px 8px;

    }

    /* Checkbox */

    .tabla-encabezado {

        font-size: 17px;

        font-weight: 600;

        color: #0d6efd;

        text-align: center;

        margin-bottom: 6px;

        border-bottom: 2px solid #0d6efd33;

        text-transform: uppercase;

        letter-spacing: 0.5px;

        padding-bottom: 2px;

        width: 100%;

    }

    .botones-laterales {

        display: flex;

        flex-direction: column;

        justify-content: space-between;

        height: 180px;

        width: 170px;

        margin-top: 40px;

    }

        .botones-laterales button {

            margin-bottom: 0 !important;

        }

        /* Botones laterales con estilo original (azul, hover salto, ancho completo) */

        .botones-laterales button {

            background-color: #007bff;

            color: white;

            border: none;

            border-radius: 8px;

            padding: 8px 12px;

            font-weight: 600;

            height: 38px;

            width: 100%;

            transition: all 0.3s ease;

        }

            .botones-laterales button:hover {

                background-color: #0056b3 !important;

                transform: translateY(-3px) !important;

                box-shadow: 0 8px 15px rgba(0,0,0,0.2) !important;

            }

            .botones-laterales button:active {

                transform: translateY(0);

            }

        .botones-laterales .btn-success {

            background-color: #28a745;

        }

            .botones-laterales .btn-success:hover {

                background-color: #218838 !important;

            }

        .botones-laterales .btn-danger {

            background-color: #dc3545;

        }

            .botones-laterales .btn-danger:hover {

                background-color: #c82333 !important;

            }

    .tabla-congelada thead th {

        position: sticky;

        top: 0;

        z-index: 10;

        background-color: #0d6efd;

        color: white;

    }

    /* Legend del groupbox alineada a la derecha */

    .groupbox-filtro legend {

        font-size: 15px;

        font-weight: 600;

        color: #0d6efd;

        width: auto;

        padding: 0 6px;

        margin-left: auto; /* ← Empuja la leyenda a la derecha */

        margin-right: 10px; /* Espacio desde el borde derecho */

    }

    /* Botón Buscar dentro del groupbox con estilo idéntico a los botones principales */

    #btnBuscarFiltro {

        background-color: #007bff !important;

        color: white !important;

        border: none;

        border-radius: 8px;

        padding: 8px 12px;

        font-weight: 600;

        height: 38px;

        min-width: 100px;

        transition: all 0.3s ease;

    }

        #btnBuscarFiltro:hover {

            background-color: #0056b3 !important;

            transform: translateY(-3px) !important;

            box-shadow: 0 8px 15px rgba(0,0,0,0.2) !important;

        }

        #btnBuscarFiltro:active {

            transform: translateY(0);

        }

    /* Reemplaza tu #empleadoSelect actual por este */

    #empleadoSelect {

        width: 100% !important;

        height: 38px !important; /* Altura fija obligatoria */

        padding: 6px 30px 6px 8px;

        border: 1px solid #ccc;

        border-radius: 6px;

        background-color: white;

        text-align-last: center;

        box-sizing: border-box;

        -webkit-appearance: none;

        -moz-appearance: none;

        appearance: none;

        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath fill='%23333' d='M1.5 0L6 4.5L10.5 0L12 1.5L6 7.5L0 1.5L1.5 0Z'/%3E%3C/svg%3E");

        background-repeat: no-repeat;

        background-position: right 10px center;

        background-size: 12px;

    }

        /* Agrega esto para limpiar las opciones internas */

        #empleadoSelect option {

            background-color: white;

            color: #333;

            padding: 8px;

            text-align: center;

        }

    select.form-control {

        -webkit-appearance: none;

        -moz-appearance: none;

        appearance: none;

        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath fill='%23333' d='M1.5 0L6 4.5L10.5 0L12 1.5L6 7.5L0 1.5L1.5 0Z'/%3E%3C/svg%3E");

        background-repeat: no-repeat;

        background-position: right 10px center;

        background-size: 12px;

    }

        /* 2. El select en sí: ocupa 100% del contenedor y no se expande */

        .campos-centrados > .campo:first-child #empleadoSelect {

            width: 100% !important;

            max-width: 100% !important;

        }

    .campos-centrados > .campo:first-child {

        flex: 0 0 250px;

        min-width: 250px;

        max-width: 250px;

    }

    /* Quitar outline y borde por defecto en TODOS los botones */

    button {

        outline: none !important;

    }

</style>

<div class="container-fluid d-flex justify-content-center align-items-center"; padding: 0;">

    <div class="card shadow-lg p-4 card-principal">

        <h2 class="text-center mb-4 fw-bold text-primary">VACACIONES DE EMPLEADOS</h2>

        <div class="row">

            <!-- Panel izquierdo -->

            <div class="col-md-2 d-flex flex-column align-items-start">

                <div id="logoContainer">

                    <img src="/images/file_0000000079e461fd8636559665695d530001.png" alt="Logo" id="farmaciaLogo" />

                </div>

                <div class="empleado-icon-container">
                    <i class="bi bi-person-badge-fill"></i>
                </div>

                @* Inasistencia *@

                <div class="botones-inferiores-container">
                <a href="/Proveedores/Inasistencia?origen=@vistaActual&idProveedor=@idProv"
                       class="btn btn-primary btn-pildora">Inasistencia</a>

                @* Volver al Index de Proveedores (usa la lista de origen) *@

                    <a href="@Url.Action("Index", "PanelSeleccion")" class="btn btn-primary btn-pildora">Volver</a>
                </div>
            </div>

            <div class="col-md-10 d-flex justify-content-start">

                <div class="bloque-principal">
                    <!-- Groupbox de filtros -->

                    <div class="groupbox-filtro @claseVisualDisabled">

                        <legend>Filtros</legend>

                        <div class="filtro-busqueda">

                            <div class="campo daterange-container">

                                <label for="btnAbrirCalendario">Rango de Fechas</label>

                                <button type="button" id="btnAbrirCalendario" class="btn btn-outline-primary shadow-sm" style="height: 38px; width: 100%;">

                                    dd/mm/yyyy - dd/mm/yyyy

                                </button>

                            </div>

                        </div>

                        <!-- Fila de Buscar Empleado + Botón Buscar (al lado derecho) -->

                        <div class="filtro-busqueda" style="margin-top: 15px; display: flex; align-items: end; gap: 10px;">

                            <div class="campo" style="flex: 1;">

                                <label for="buscarEmpleadoInput">Buscar Empleado</label>

                                <input type="text" id="buscarEmpleadoInput" class="form-control shadow-sm" placeholder="Escriba aquí..." style="text-align: left;" />

                            </div>

                            <div class="campo" style="align-self: end;">

                                <button id="btnBuscarFiltro">Buscar</button>

                            </div>

                        </div>

                    </div>

                    <!-- CAMPOS PARA AGREGAR VACACIÓN (arriba de la tabla) -->

                    <!-- CAMPOS PARA AGREGAR VACACIÓN (dos filas) -->

                    <!-- CAMPOS PARA AGREGAR VACACIÓN (dos filas, alineados perfectamente) -->

                    <!-- CAMPOS PARA AGREGAR VACACIÓN (dos filas, alineados perfectamente) -->

                    <div class="@claseVisualDisabled">

                        <!-- Fila 1: Empleado y Días -->

                        <div class="campos-centrados" style="margin-bottom: 10px !important;">

                            <div class="campo" style="flex: 0 0 250px;">

                                <label for="empleadoSelect">Empleado</label>

                                <select id="empleadoSelect" class="form-control shadow-sm">

                                    <option value="">Seleccione Empleado</option>

                                    @if (ViewBag.Empleados != null)

                                    {

                                        foreach (var emp in ViewBag.Empleados)

                                        {

                                            <option value="@emp.Idusuario" data-nombre="@emp.NombreCompleto">

                                                @emp.NombreCompleto - DNI: @emp.Dni

                                            </option>

                                        }

                                    }

                                </select>

                            </div>

                            <div class="campo" style="flex: 0 0 150px; max-width: 150px;">

                                <label for="diasInput">Días Solicitados</label>

                                <input type="number" id="diasInput" class="form-control shadow-sm" min="0" max="60" value="0" />

                            </div>

                        </div>

                        <!-- Fila 2: Fecha Inicio y Fecha Fin -->

                        <!-- Período (mismo estilo que el filtro) -->

                        <div class="campos-centrados" style="margin-top: 15px; margin-bottom: 10px !important;">

                            <div class="campo" style="flex: 0 0 400px; max-width: 400px;">

                                <label for="btnPeriodo">Período de Vacaciones</label>

                                <button type="button" id="btnPeriodo" class="btn btn-outline-primary shadow-sm w-100" style="height: 38px;">

                                    dd/mm/yyyy - dd/mm/yyyy

                                </button>

                            </div>

                        </div>

                    </div>

                    <!-- Tabla y botones -->

                    <div class="contenedor-tablas-botones mt-3">

                        <div class="table-wrapper">

                            <div class="tabla-encabezado">REGISTROS DE VACACIONES</div>

                            <div class="table-responsive">

                                <table class="table table-bordered table-hover align-middle tabla-congelada" id="tablaVacaciones">

                                    <thead class="table-primary">

                                        <tr>

                                            <th>Empleado</th>

                                            <th>Días</th>

                                            <th>Período</th> <!-- Nueva columna única -->

                                            <th>Días Favor</th>

                                            <th><input type="checkbox" id="checkAll" class="form-check-input" /></th>

                                        </tr>

                                    </thead>

                                    <tbody>

                                        @foreach (var v in Model)

                                        {

                                            <tr data-vacacion-id="@v.IdVacaciones">

                                                <td class="empleado-clickable">@(v.NombreEmpleadoRegistrado ?? "Sin nombre")</td>

                                                <td class="text-center">@v.DiasVacaciones</td>

                                                <td class="text-center">

                                                    @v.FechaInicio.ToString("dd/MM/yyyy") - @v.FechaFin.ToString("dd/MM/yyyy")

                                                </td>

                                                <td class="text-center">@Math.Abs(v.DiasFavor)</td>

                                                <td><input type="checkbox" class="form-check-input fila-check" /></td>

                                            </tr>

                                        }

                                    </tbody>

                                </table>

                            </div>

                        </div>

                        <div class="botones-laterales @claseVisualDisabled">

                            <button id="btnAgregar">Agregar</button>

                            <button id="btnGuardar">Guardar</button>

                            <button id="btnNuevoRegistro">Nuevo Registro</button>

                            <button id="btnEliminar">Eliminar</button>

                        </div>

                    </div>

                </div>

            </div>

        </div>

    </div>

</div>

@section Scripts {

    <!-- Librerías -->

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/locale/es.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css" />

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script src="https://cdn.jsdelivr.net/npm/exceljs/dist/exceljs.min.js"></script>

    <script>


        // Inicialización de calendarios (más robusta)

        $(document).ready(function () {

            const commonOptions = {

                autoUpdateInput: false,

                opens: 'left',

                locale: {

                    format: 'DD/MM/YYYY',

                    applyLabel: 'Aplicar',

                    cancelLabel: 'Limpiar',

                    daysOfWeek: ['Do', 'Lu', 'Ma', 'Mi', 'Ju', 'Vi', 'Sa'],

                    monthNames: ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre']

                }

            };

            // Calendario FILTROS

            $('#btnAbrirCalendario').daterangepicker(commonOptions);

            $('#btnAbrirCalendario').on('apply.daterangepicker', function(ev, picker) {

                $(this).text(picker.startDate.format('DD/MM/YYYY') + ' - ' + picker.endDate.format('DD/MM/YYYY'));

            });

            $('#btnAbrirCalendario').on('cancel.daterangepicker', function() {

                $(this).text('dd/mm/yyyy - dd/mm/yyyy');

            });

            // Calendario PERÍODO

            $('#btnPeriodo').daterangepicker(commonOptions);

            $('#btnPeriodo').on('apply.daterangepicker', function(ev, picker) {

                $(this).text(picker.startDate.format('DD/MM/YYYY') + ' - ' + picker.endDate.format('DD/MM/YYYY'));

            });

            $('#btnPeriodo').on('cancel.daterangepicker', function() {

                $(this).text('dd/mm/yyyy - dd/mm/yyyy');

            });

            // Forzar apertura al click

            $('#btnAbrirCalendario, #btnPeriodo').on('click', function(e) {

                e.preventDefault();

                e.stopPropagation();

                const picker = $(this).data('daterangepicker');

                if (picker) picker.show();

            });

        });

        // Lógica principal de la página

        document.addEventListener('DOMContentLoaded', function () {

            const TABLA_ID = "tablaVacaciones";

            const MIN_FILAS_VISIBLE = 5;

            function agregarFilasVacias() {

                const tbody = document.querySelector(`#${TABLA_ID} tbody`);

                if (!tbody) return;

                document.querySelectorAll('tr.fila-relleno').forEach(f => f.remove());

                const filasConDatos = document.querySelectorAll('tr[data-vacacion-id]').length;

                const filasNecesarias = Math.max(0, MIN_FILAS_VISIBLE - filasConDatos);

                for (let i = 0; i < filasNecesarias; i++) {

                    const filaVacia = document.createElement('tr');

                    filaVacia.classList.add('fila-relleno');

                    filaVacia.innerHTML = `

                        <td>&nbsp;</td>

                        <td class="text-center">&nbsp;</td>

                        <td class="text-center">&nbsp;</td>

                        <td class="text-center">&nbsp;</td>

                        <td><input type="checkbox" class="form-check-input fila-check" disabled /></td>

                    `;

                    tbody.appendChild(filaVacia);

                }


            }

            agregarFilasVacias();








            // Buscar Filtro

             document.getElementById('btnBuscarFiltro').addEventListener('click', async function () {
            const nombre = document.getElementById('buscarEmpleadoInput').value.trim();
            const rangoBtn = document.getElementById('btnAbrirCalendario');
            const rangoTexto = rangoBtn.textContent.trim();

            let fDesde = null;
            let fHasta = null;
            if (rangoTexto !== 'dd/mm/yyyy - dd/mm/yyyy') {
                const partes = rangoTexto.split(' - ');
                if (partes.length === 2) {
                    try {
                        const desdeParts = partes[0].split('/');
                        const hastaParts = partes[1].split('/');
                        fDesde = `${desdeParts[2]}-${desdeParts[1]}-${desdeParts[0]}`;
                        fHasta = `${hastaParts[2]}-${hastaParts[1]}-${hastaParts[0]}`;
                    } catch (e) {
                        Swal.fire('Error', 'Formato de fecha inválido', 'error');
                        return;
                    }
                }
            }

            const hayNombre = nombre !== '';
            const hayRango = fDesde !== null && fHasta !== null;

            if (!hayNombre && !hayRango) {
                Swal.fire({
                    title: 'Atención',
                    text: 'Ingrese al menos un filtro (nombre o rango de fechas)',
                    confirmButtonText: 'Entendido',
                    confirmButtonColor: '#007bff'
                });
                return;
            }

            try {
                const url = `/Vacaciones/BuscarVacaciones?nombreEmpleado=${encodeURIComponent(nombre)}&fechaDesde=${fDesde || ''}&fechaHasta=${fHasta || ''}`;
                console.log("URL enviada:", url);

                const response = await fetch(url);
                if (!response.ok) throw new Error(`Error ${response.status}`);

                const data = await response.json();

                const tbody = document.querySelector('#tablaVacaciones tbody');

                // Solo limpiamos y actualizamos si hay resultados
                if (data.length > 0) {
                    tbody.innerHTML = '';  // Limpiamos SOLO si hay data
                    data.sort((a, b) => parseInt(b.idVacaciones) - parseInt(a.idVacaciones));
                    data.forEach(v => {
                        const fila = document.createElement('tr');
                        fila.setAttribute('data-vacacion-id', v.idVacaciones);
                        fila.innerHTML = `
                            <td class="empleado-clickable">${v.nombreEmpleado}</td>
                            <td class="text-center">${v.diasVacaciones}</td>
                            <td class="text-center">${v.fechaInicio} - ${v.fechaFin}</td>
                            <td class="text-center">${v.diasFavor}</td>
                            <td><input type="checkbox" class="form-check-input fila-check" /></td>
                        `;
                        tbody.appendChild(fila);
                    });

                    Swal.fire({
                        icon: 'success',
                        title: 'Búsqueda exitosa',
                        text: `Se encontraron ${data.length} registros.`,
                        timer: 2000,
                        showConfirmButton: false
                    });
                } else {
                    // No hay resultados → NO limpiamos la tabla
                    Swal.fire({
                        title: 'Sin resultados',
                        text: 'No se encontraron vacaciones con esos filtros.',
                        confirmButtonText: 'Entendido',
                        confirmButtonColor: '#007bff'
                    });
                }

                if (typeof agregarFilasVacias === "function") agregarFilasVacias();
            } catch (err) {
                console.error('Error:', err);
                Swal.fire('Error', 'No se pudo realizar la búsqueda.', 'error');
            }
        });

                // Validación y lógica completa de Agregar

            document.getElementById('btnAgregar').addEventListener('click', async function (e) {
            const elEmpleado = document.getElementById('empleadoSelect');
            const elDias = document.getElementById('diasInput');
            const btnPeriodo = document.getElementById('btnPeriodo');

            if (!elEmpleado || !elDias || !btnPeriodo) {
                Swal.fire('Error', 'No se encontraron los campos necesarios.', 'error');
                return;
            }

            const empleadoId = elEmpleado.value?.trim() || '';
            const empleadoNombre = elEmpleado.options[elEmpleado.selectedIndex]?.getAttribute('data-nombre') || '';
            const diasSolicitados = parseInt(elDias.value) || 0;
            const periodoTexto = btnPeriodo.textContent.trim();

            // Validaciones básicas
            if (!empleadoId || empleadoId === '') {
                Swal.fire('Error', 'Seleccione un empleado', 'error');
                return;
            }

            if (periodoTexto === 'dd/mm/yyyy - dd/mm/yyyy') {
                Swal.fire('Error', 'Seleccione el período de vacaciones', 'error');
                return;
            }

            const [desde, hasta] = periodoTexto.split(' - ');
            const inicioDate = new Date(desde.split('/').reverse().join('-'));
            const finDate = new Date(hasta.split('/').reverse().join('-'));

            if (isNaN(inicioDate) || isNaN(finDate) || finDate < inicioDate) {
                Swal.fire('Error', 'Fechas inválidas o fin anterior al inicio', 'error');
                return;
            }

            // Calcular días reales del período (corridos)
            const diasReales = Math.floor((finDate - inicioDate) / (1000 * 60 * 60 * 24)) + 1;

            if (diasReales > diasSolicitados) {
            Swal.fire({
                title: 'Período mayor al solicitado',
                html: `Solicitaste <b>${diasSolicitados} días</b>, pero el período elegido tiene <b>${diasReales} días reales</b>.<br><br>
                       El período no puede ser mayor a los días solicitados.<br>
                       Ajusta el rango de fechas o aumenta los días solicitados.`,
                confirmButtonText: 'Entendido',
                confirmButtonColor: '#007bff'
            });
            document.getElementById('btnPeriodo').focus();
            return; 
            }

            // Validación 1: días solicitados ≤ máximo legal
            const maxLegal = parseInt(elDias.max) || 60;
            if (diasSolicitados > maxLegal) {
                e.preventDefault();
                Swal.fire({
                    title: 'Exceso de días solicitados',
                    html: `No se pueden solicitar más de <b>${maxLegal} días</b> según la antigüedad del empleado (LCT).<br>
                           Días solicitados: ${diasSolicitados} (máximo permitido: ${maxLegal})`,
                    confirmButtonText: 'Entendido',
                    confirmButtonColor: '#007bff'
                });
                elDias.focus();
                return;
            }

            // Validación 2: días reales del período ≤ máximo legal
            if (diasReales > maxLegal) {
                e.preventDefault();

                // Mostrar Swal SIN abrir el calendario
                Swal.fire({
                    title: 'Período demasiado largo',
                    html: `El período seleccionado tiene <b>${diasReales} días corridos</b>, pero solo corresponden <b>${maxLegal} días</b> por ley.<br>
                           Reduce el rango de fechas o ajusta los días solicitados.`,
                    confirmButtonText: 'Entendido',
                    confirmButtonColor: '#007bff'
                }).then(() => {
                    // Después de cerrar el Swal, enfocar el botón para que pueda corregir
                    btnPeriodo.focus();
                });

                // Enfocar el botón (sin abrir el calendario)
                btnPeriodo.focus();
                return;
            }




                    // Chequeo de vacaciones solapadas (mismo empleado o cualquier otro)
        const empleadoIdNum = parseInt(empleadoId);
        if (isNaN(empleadoIdNum) || empleadoIdNum <= 0) {
            Swal.fire('Error', 'ID de empleado inválido. Selecciona nuevamente.', 'error');
            elEmpleado.focus();
            return;
        }

        const fechaInicioStr = inicioDate.toISOString().split('T')[0];
        const fechaFinStr = finDate.toISOString().split('T')[0];

        try {
            const url = `/Vacaciones/CheckVacacionesSolapadas?idEmpleadoNuevo=${empleadoIdNum}&fechaInicio=${fechaInicioStr}&fechaFin=${fechaFinStr}`;
            console.log('Verificando solapamiento:', url);

            const response = await fetch(url);
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }

            const data = await response.json();

            if (!data.permitido) {
            Swal.fire({
                title: '¡Período no permitido!',
                html: data.mensaje || 'El período se superpone con otra vacación.',
                confirmButtonText: 'Entendido',
                confirmButtonColor: '#007bff'  // rojo para error
            });
            btnPeriodo.focus();
            return;
            }   
        } catch (err) {
            console.error('Error al verificar solapamiento:', err);
            const continuar = await Swal.fire({
                title: 'Error al verificar cobertura',
                text: 'No se pudo comprobar si hay empleados en vacaciones en ese período. ¿Querés guardar de todos modos?',
                showCancelButton: true,
                confirmButtonText: 'Sí, guardar',
                cancelButtonText: 'No, revisar',
                confirmButtonColor: '#007bff',
                cancelButtonColor: '#007bff'
            });

            if (!continuar.isConfirmed) {
                btnPeriodo.focus();
                return;
            }
        }

            const datos = {
                Idusuario: parseInt(empleadoId),
                DiasVacaciones: diasSolicitados,
                FechaInicio: inicioDate.toISOString(),
                FechaFin: finDate.toISOString(),
                NombreEmpleadoFrontend: empleadoNombre
            };

            try {
                const response = await fetch('/Vacaciones/ApiCreate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''
                    },
                    body: JSON.stringify(datos)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Error ${response.status}: ${errorText}`);
                }

                const result = await response.json();

                if (result.success) {
                    const valorDiasFavor = result.diasFavor;
                    const tbody = document.querySelector('#tablaVacaciones tbody');
                    const nuevaFila = document.createElement('tr');
                    nuevaFila.setAttribute('data-vacacion-id', result.id);
                    nuevaFila.innerHTML = `
                        <td class="empleado-clickable">${empleadoNombre}</td>
                        <td class="text-center">${diasSolicitados}</td>
                        <td class="text-center">${desde} - ${hasta}</td>
                        <td class="text-center">${valorDiasFavor}</td>
                        <td><input type="checkbox" class="form-check-input fila-check" /></td>
                    `;
                    tbody.insertBefore(nuevaFila, tbody.firstChild);

                    elEmpleado.value = '';
                    elDias.value = '0';
                    btnPeriodo.textContent = 'dd/mm/yyyy - dd/mm/yyyy';
                    agregarFilasVacias();

                    Swal.fire({
                        icon: 'success',
                        title: '¡Agregado!',
                        text: `Vacación registrada. Días a favor restantes: ${valorDiasFavor}`,
                        timer: 2500,
                        showConfirmButton: false
                    });
                } else {
                    Swal.fire('Error', result.message || 'No se pudo guardar', 'error');
                }
            } catch (err) {
                console.error('Error en ApiCreate:', err);
                Swal.fire('Error', 'No se pudo conectar con el servidor.', 'error');
            }
        });

            // btnNuevoRegistro

            document.getElementById('btnNuevoRegistro').addEventListener('click', function () {

                const tbody = document.querySelector(`#${TABLA_ID} tbody`);

                tbody.innerHTML = '';

                agregarFilasVacias();

                Swal.fire({

                    icon: 'success',

                    title: 'Tabla limpiada',

                    text: 'Puede comenzar un nuevo registro.',

                    timer: 2500,

                    showConfirmButton: false

                });

            });

            // btnEliminar

            document.getElementById('btnEliminar').addEventListener('click', async function () {

                const checkboxes = document.querySelectorAll(`#${TABLA_ID} .fila-check:checked`);

                if (checkboxes.length === 0) {

                    Swal.fire({

                        title: 'Atención',

                        text: 'Debe seleccionar al menos un registro para eliminar.',

                        confirmButtonText: 'Entendido',

                        confirmButtonColor: '#007bff'

                    });

                    return;

                }

                const result = await Swal.fire({

                    title: 'Confirmar eliminación',

                    text: `Se eliminarán ${checkboxes.length} registro(s) de vacaciones.`,

                    showCancelButton: true,

                    confirmButtonText: 'Sí, eliminar',

                    cancelButtonText: 'Cancelar',

                    confirmButtonColor: '#007bff',

                    cancelButtonColor: '#007bff'

                });

                if (!result.isConfirmed) return;

                let eliminados = 0;

                for (const chk of checkboxes) {

                    const tr = chk.closest('tr');

                    const id = tr.getAttribute('data-vacacion-id');

                    if (id && parseInt(id) > 0) {

                        try {

                            const resp = await fetch(`/Vacaciones/EliminarVacacion?id=${id}`, { method: 'DELETE' });

                            const data = await resp.json();

                            if (data.success) {

                                tr.remove();

                                eliminados++;

                            }

                        } catch (err) {

                            console.error(err);

                        }

                    } else {

                        tr.remove();

                        eliminados++;

                    }

                }

                agregarFilasVacias();

                Swal.fire({

                    title: '¡Eliminado!',

                    text: `${eliminados} registro(s) eliminados correctamente.`,

                    icon: 'success',

                    confirmButtonText: 'Entendido',

                    confirmButtonColor: '#007bff'

                });

            });

            // btnGuardar

                    document.getElementById('btnGuardar').addEventListener('click', async function () {
            const filas = document.querySelectorAll(`#${TABLA_ID} tbody tr[data-vacacion-id]:not([data-vacacion-id='0'])`);
            if (filas.length === 0) {
                Swal.fire('Sin datos', 'No hay registros para exportar.', 'warning');
                return;
            }

            // 1. Recolectar datos + calcular totales
            const datos = [];
            let totalSolicitados = 0;
            let totalReales = 0;
            let totalFavor = 0;
            const porEmpleado = {}; // { "Nerea Loza": { solicitados: 0, reales: 0, favor: 0 } }

            filas.forEach(f => {
                const celdas = f.querySelectorAll('td');
                const empleado = celdas[0].innerText.trim();
                const solicitados = parseInt(celdas[1].innerText.trim()) || 0;
                const periodo = celdas[2].innerText.trim();
                const favor = parseInt(celdas[3].innerText.trim()) || 0;

                datos.push([empleado, solicitados, periodo, favor]);

                totalSolicitados += solicitados;
                // Calcular días reales del período (simplificado)
                const [inicioStr, finStr] = periodo.split(' - ');
                const inicio = new Date(inicioStr.split('/').reverse().join('-'));
                const fin = new Date(finStr.split('/').reverse().join('-'));
                const reales = Math.floor((fin - inicio) / (1000*60*60*24)) + 1 || solicitados;
                totalReales += reales;
                totalFavor += favor;

                if (!porEmpleado[empleado]) porEmpleado[empleado] = { solicitados: 0, reales: 0, favor: 0 };
                porEmpleado[empleado].solicitados += solicitados;
                porEmpleado[empleado].reales += reales;
                porEmpleado[empleado].favor += favor;
            });

            // 2. Generar Excel con resumen
            const workbook = new ExcelJS.Workbook();
            const sheet = workbook.addWorksheet('VACACIONES');

            // Título
            sheet.addRow(['REGISTRO DE VACACIONES']);
            sheet.mergeCells('A1:D1');
            const titleCell = sheet.getCell('A1');
            titleCell.font = { size: 16, bold: true };
            titleCell.alignment = { horizontal: 'center' };
            titleCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFF5F5DC' } };

            // Encabezados
            const headers = ['EMPLEADO', 'DÍAS SOLICITADOS', 'PERÍODO', 'DÍAS FAVOR'];
            sheet.addRow(headers);
            const headerRow = sheet.lastRow;
            headerRow.eachCell(cell => {
                cell.font = { bold: true };
                cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFFFC080' } };
                cell.alignment = { horizontal: 'center' };
            });

            // Datos
            datos.forEach((row, i) => {
                const dataRow = sheet.addRow(row);
                dataRow.eachCell(cell => {
                    cell.alignment = { horizontal: 'center' };
                    cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: i % 2 === 0 ? 'FFDDEEFF' : 'FFCCFFFF' } };
                });
            });

            // Resumen general
            sheet.addRow([]); // línea en blanco
            sheet.addRow(['RESUMEN GENERAL']);
            sheet.mergeCells('A' + sheet.rowCount + ':D' + sheet.rowCount);
            sheet.getCell('A' + sheet.rowCount).font = { bold: true, color: { argb: 'FFFFFFFF' } };
            sheet.getCell('A' + sheet.rowCount).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF006400' } }; // verde oscuro

            sheet.addRow(['Total días solicitados:', totalSolicitados]);
            sheet.addRow(['Total días reales tomados:', totalReales]);
            sheet.addRow(['Total días favor (suma):', totalFavor]);

            // Resumen por empleado
            sheet.addRow([]); // línea en blanco
            sheet.addRow(['RESUMEN POR EMPLEADO']);
            sheet.mergeCells('A' + sheet.rowCount + ':D' + sheet.rowCount);
            sheet.getCell('A' + sheet.rowCount).font = { bold: true };

            for (const [empleado, vals] of Object.entries(porEmpleado)) {
                sheet.addRow([empleado, vals.solicitados, vals.reales, vals.favor]);
            }

            // Anchos de columnas
            sheet.columns = [
                { width: 30 }, { width: 18 }, { width: 35 }, { width: 15 }
            ];

            // Descarga
            const buffer = await workbook.xlsx.writeBuffer();
            const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `Registro Vacaciones ${new Date().toLocaleDateString('es-AR')} ${new Date().toLocaleTimeString('es-AR')}.xlsx`;
            link.click();
        });

            // Selección de filas y check all

                    // ────────────────────────────────────────────────
        // SELECCIÓN DE FILAS + COLOR AZUL (igual que Inasistencias)
        // ────────────────────────────────────────────────

        // 1. Listener de clic en toda la tabla (para toggle checkbox y color)
                // Listener de clic en la tabla (selección + color azul)
        document.querySelector(`#${TABLA_ID} tbody`).addEventListener('click', function (e) {
            const fila = e.target.closest('tr');
            if (!fila || fila.getAttribute('data-vacacion-id') === '0') return;

            // Evitar interferir con clic en nombre del empleado
            if (e.target.closest('.empleado-clickable')) return;

            const checkbox = fila.querySelector('.fila-check');
            if (checkbox) {
                // Caso 1: Clic directo en el checkbox → navegador maneja checked, nosotros solo color
                if (e.target === checkbox || e.target.type === 'checkbox') {
                    // Usamos setTimeout(0) para que se ejecute después del cambio del navegador
                    setTimeout(() => {
                        fila.classList.toggle('fila-seleccionada', checkbox.checked);
                    }, 0);
                } else {
                    // Caso 2: Clic en cualquier otra parte de la fila → toggleamos manualmente
                    checkbox.checked = !checkbox.checked;
                    fila.classList.toggle('fila-seleccionada', checkbox.checked);
                }
            }

            // Sincronizar checkbox maestro
            const checkAll = document.getElementById('checkAll');
            if (checkAll) {
                const filasConDatos = document.querySelectorAll(`#${TABLA_ID} tbody tr[data-vacacion-id]:not([data-vacacion-id='0'])`);
                const checksMarcados = document.querySelectorAll(`#${TABLA_ID} tbody tr[data-vacacion-id]:not([data-vacacion-id='0']) .fila-check:checked`);
                checkAll.checked = (checksMarcados.length > 0 && checksMarcados.length === filasConDatos.length);
            }
        });

        // Checkbox maestro (seleccionar todo)
        document.getElementById('checkAll').addEventListener('change', function () {
            const isChecked = this.checked;
            const filasVisibles = document.querySelectorAll(`#${TABLA_ID} tbody tr[data-vacacion-id]:not([data-vacacion-id='0'])`);

            filasVisibles.forEach(fila => {
                const checkbox = fila.querySelector('.fila-check');
                if (checkbox) {
                    checkbox.checked = isChecked;
                    fila.classList.toggle('fila-seleccionada', isChecked);
                }
            });
        });

        // 3. Asegurarse de que al filtrar o cargar se mantenga la lógica (opcional, pero recomendado)
        function actualizarSeleccionVisual() {
            document.querySelectorAll(`#${TABLA_ID} tbody tr[data-vacacion-id]:not([data-vacacion-id='0'])`).forEach(fila => {
                const checkbox = fila.querySelector('.fila-check');
                if (checkbox) {
                    fila.classList.toggle('fila-seleccionada', checkbox.checked);
                }
            });
        }
        actualizarSeleccionVisual();




                    // Al hacer click en el nombre del empleado en la tabla

                document.querySelector('#tablaVacaciones tbody').addEventListener('click', function (e) {

            const td = e.target.closest('td');

            if (!td || td.cellIndex !== 0) return;

            e.stopPropagation();

            const nombreCompleto = td.innerText.trim();

            if (!nombreCompleto || nombreCompleto === 'Sin nombre') return;

            fetch(`/Vacaciones/GetDatosEmpleado?nombre=${encodeURIComponent(nombreCompleto)}`)

                .then(response => response.json())

                .then(data => {

                    if (data.success) {

                        Swal.fire({

                            title: data.nombreCompleto,

                            html: `

                                <div style="margin-top: 20px; color: #555;">

                                    <p style="margin-bottom: 12px; font-size: 1.2rem;"><strong>DNI:</strong> ${data.dni || 'No disponible'}</p>

                                    <p style="margin-bottom: 12px; font-size: 1.2rem;"><strong>Teléfono:</strong> ${data.telefono || 'No disponible'}</p>

                                    <p style="margin-bottom: 10px; font-size: 1.2rem;"><strong>Dirección:</strong> ${data.direccion || 'No disponible'}</p>

                                    <p style="margin-bottom: 12px; font-size: 1.2rem; color: #007bff; font-weight: bold;">
                <strong>Días de Vacaciones:</strong> ${data.diasVacacionesLegales} días corridos
            </p>
                                </div>

                            `,

                            confirmButtonText: 'Entendido',

                            confirmButtonColor: '#007bff',

                            showCloseButton: false,

                            customClass: {

                                popup: 'rounded-4 shadow-lg',

                                title: 'custom-swal-title', // Clase personalizada

                                confirmButton: 'px-5 py-2 fs-5 fw-bold' // Botón más robusto

                            },

                            didOpen: () => {

                                // Aplicamos el color azul específico al título directamente

                                const title = Swal.getTitle();

                                title.style.color = '#007bff';

                                title.style.fontSize = '1.8rem';

                                title.style.fontWeight = 'bold';

                            }

                        });

                    } else {

                        Swal.fire('No encontrado', data.message || 'No se encontraron datos', 'warning');

                    }

                })

                .catch(() => {

                    Swal.fire('Error', 'No se pudo cargar los datos del empleado', 'error');

                });

        });

                // Evento al seleccionar empleado

                document.getElementById('empleadoSelect').addEventListener('change', async function () {

                const empleadoId = this.value;

                const diasInput = document.getElementById('diasInput');

                if (!empleadoId || empleadoId === "") {

                    diasInput.max = 60;

                    diasInput.value = 0;

                    diasInput.disabled = false;

                    return;

                }

                try {

                    const response = await fetch(`/Vacaciones/GetDiasPermitidos?idUsuario=${empleadoId}`);

                        if (!response.ok) {

                            throw new Error(`HTTP ${response.status}`);

                        }

                    const data = await response.json();

                    if (data.success) {

                        diasInput.max = data.diasPermitidos;

                        diasInput.value = data.diasPermitidos;

                        diasInput.disabled = false;

                        Swal.fire({

                            title: 'Días permitidos por ley',

                            html: `Al empleado seleccionado le corresponden <b>${data.diasPermitidos} días corridos</b> de vacaciones este año.<br>

                                   <small>(antigüedad: ${data.antiguedadAnios} años - LCT art. 150)</small>`,

                            confirmButtonText: 'Entendido',

                            confirmButtonColor: '#007bff'

                        });

                    } else {

                        Swal.fire('Atención', data.message || 'No se pudo calcular la antigüedad.', 'warning');

                        diasInput.max = 60;

                        diasInput.value = 0;

                    }

                } catch (err) {

                        console.error('Error completo al consultar GetDiasPermitidos:', err);

                        Swal.fire({

                        title: 'Error de conexión',

                        html: 'No se pudo obtener los días permitidos.<br><small>Verifica que el servidor esté actualizado o contacta al administrador.</small>',

                        confirmButtonText: 'Etendido',

                        confirmButtonColor: '#007bff'

                });

                diasInput.max = 60;

                diasInput.value = 0;

                }

            });





                    // Bloquear escritura directa en Días Solicitados, permitir solo flechas
        document.getElementById('diasInput').addEventListener('keydown', function(e) {
            // Permitir flechas arriba (38) y abajo (40)
            if (e.keyCode === 38 || e.keyCode === 40) {
                return; // Dejar que las flechas funcionen normalmente
            }

            // Permitir teclas de control básicas (Tab, Backspace, Delete, flechas laterales para mover cursor si querés)
            if ([9, 8, 46, 37, 39].includes(e.keyCode)) {
                return;
            }

            // Bloquear todo lo demás (números, letras, etc.)
            e.preventDefault();
        });

        // Opcional: bloquear también pegado (paste) para evitar escribir con Ctrl+V
        document.getElementById('diasInput').addEventListener('paste', function(e) {
            e.preventDefault();
        });


        });

    </script>

}




