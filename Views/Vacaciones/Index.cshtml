@model IEnumerable<FarmaciaSantaRita.Models.Vacacion>
@using System.Security.Claims

@{
    ViewData["Title"] = "Vacaciones de Empleados";
    var idProv = (ViewData["IdProveedor"] ?? Context.Request.Query["idProveedor"].FirstOrDefault() ?? "0").ToString();
    string rolUsuario = User.FindFirstValue(ClaimTypes.Role);
    bool esJefe = rolUsuario == "Jefe/a";
    string claseVisualDisabled = esJefe ? "" : "contenedor-deshabilitado";
    string disabledAttr = esJefe ? "" : "disabled=\"disabled\"";
    string vistaActual = Context.Request.Query["vista"].ToString()
                         ?? Context.Request.Query["vistaOrigen"].ToString()
                         ?? Context.Request.Query["origen"].ToString()
                         ?? ViewData["vista"]?.ToString()
                         ?? "ProveedorSecundario";
}

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
    .empleado-clickable {
        cursor: pointer;
        color: #007bff;
        text-decoration: underline;
        transition: color 0.2s ease;
    }

        .empleado-clickable:hover {
            color: #0056b3;
        }

    /* Tus estilos existentes (los mismos de Inasistencias) */
    .contenedor-deshabilitado {
        pointer-events: none;
        opacity: 0.6;
        filter: grayscale(40%);
    }

    .card-principal {
        width: 100%;
        max-width: 1200px;
        margin: 0 auto;
        transition: width 0.3s ease;
        position: relative;
        border-radius: 16px;
    }

    .bloque-principal {
        display: flex;
        flex-direction: column;
        flex-wrap: nowrap;
        align-items: flex-start;
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        padding: 65px 20px 20px 20px;
        width: 100%;
        max-width: 1100px;
        margin: 0 auto;
        max-height: 480px;
        overflow: visible;
        position: relative;
    }

    .row > .col-md-2 {
        margin-top: -115px;
        height: 420px;
        display: flex;
        top: 0;
        z-index: 10;
        position: sticky;
        flex-direction: column;
        justify-content: flex-start;
        align-items: center !important;
        padding-top: 50px;
    }

    .col-md-2 a.btn {
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 8px;
        padding: 8px 12px;
        font-weight: 600;
        height: 40px;
        min-width: 140px;
        width: 100%;
        max-width: 180px;
        display: flex;
        margin-bottom: 10px;
        text-align: center;
        justify-content: center;
        align-items: center;
        text-decoration: none;
        transition: all 0.3s ease;
    }

        .col-md-2 a.btn:hover {
            background-color: #0056b3 !important;
            transform: translateY(-3px) !important;
            box-shadow: 0 8px 15px rgba(0,0,0,0.2) !important;
        }

    #logoContainer {
        min-width: 140px;
        width: 100%;
        max-width: 180px;
        height: 200px;
        margin-bottom: 10px;
        display: flex;
        justify-content: center;
        align-items: center;
        background-color: transparent;
        border-radius: 8px;
        border: none;
        padding: 5px;
    }

    #farmaciaLogo {
        width: 100%;
        height: 100%;
        object-fit: contain;
    }

    .groupbox-filtro {
        border: 1px solid #0d6efd;
        border-radius: 8px;
        padding: 8px 14px 10px 14px;
        background-color: #f7f9fc;
        position: absolute;
        top: 20px;
        right: 20px; /* Mantiene el margen derecho */
        left: 580px; /* ← Extiende hacia la izquierda hasta cerca de los campos */
        z-index: 1000;
        width: auto; /* Se ajusta entre left y right */
        max-width: none;
        box-shadow: 0 1px 5px rgba(0, 0, 0, 0.1);
        height: auto; /* Permite que se estire */
        min-height: 200px; /* Altura mínima para que se vea bien */
    }

        .groupbox-filtro legend {
            font-size: 15px;
            font-weight: 600;
            color: #0d6efd;
            width: auto;
            padding: 0 6px;
            margin-left: 5px;
        }

    .campos-centrados {
        display: flex;
        justify-content: flex-start;
        align-items: flex-end;
        width: 100%;
        gap: 15px;
        margin-bottom: 25px !important;
        flex-wrap: wrap;
    }

    .campo {
        display: flex;
        flex-direction: column;
        align-items: flex-start;
    }

        .campo label {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .campo input, .campo select {
            padding: 6px 8px;
            border-radius: 6px;
            border: 1px solid #ccc;
            box-sizing: border-box;
            width: 100%;
            height: 38px;
            text-align: center;
        }

        .campo select {
            text-align-last: center;
        }

    .contenedor-tablas-botones {
        display: flex;
        flex-direction: row;
        justify-content: flex-start;
        align-items: stretch;
        width: 100%;
        max-width: 1100px;
        margin: 0;
        gap: 35px;
        flex-wrap: nowrap;
        height: auto;
    }

    .table-wrapper {
        flex: 0 0 740px;
        max-width: 740px;
    }

    .table-responsive {
        height: 180px;
        max-height: 180px;
        overflow-y: auto;
        overflow-x: hidden;
        border: 1px solid #dee2e6;
    }

    .table {
        table-layout: fixed;
        width: 100%;
    }

        .table th, .table td {
            text-align: center;
            vertical-align: middle;
            padding: 4px 8px;
            border: 1px solid #dee2e6;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

    #tablaVacaciones th:nth-child(1), #tablaVacaciones td:nth-child(1) {
        width: 25%;
    }
    /* Empleado */
    #tablaVacaciones th:nth-child(2), #tablaVacaciones td:nth-child(2) {
        width: 15%;
    }
    /* Días */
    #tablaVacaciones th:nth-child(3), #tablaVacaciones td:nth-child(3) {
        width: 30%;
        white-space: nowrap; /* evita saltos de línea */
    }
    #tablaVacaciones th:nth-child(5), #tablaVacaciones td:nth-child(5) {
        width: 15%;
    }
    /* Días Favor */
    #tablaVacaciones th:nth-child(6), #tablaVacaciones td:nth-child(6) {
        width: 5%;
    }

    #tablaVacaciones td, #tablaVacaciones th {
        height: 32px; /* ← Reducida a 32px → filas más cortas y elegantes */
        padding: 2px 8px;
    }

    /* Checkbox */
    .tabla-encabezado {
        font-size: 17px;
        font-weight: 600;
        color: #0d6efd;
        text-align: center;
        margin-bottom: 6px;
        border-bottom: 2px solid #0d6efd33;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        padding-bottom: 2px;
        width: 100%;
    }

    .botones-laterales {
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        height: 180px;
        width: 170px;
        margin-top: 40px;
    }

        .botones-laterales button {
            margin-bottom: 0 !important;
        }

        /* Botones laterales con estilo original (azul, hover salto, ancho completo) */
        .botones-laterales button {
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 8px 12px;
            font-weight: 600;
            height: 38px;
            width: 100%;
            transition: all 0.3s ease;
        }

            .botones-laterales button:hover {
                background-color: #0056b3 !important;
                transform: translateY(-3px) !important;
                box-shadow: 0 8px 15px rgba(0,0,0,0.2) !important;
            }

            .botones-laterales button:active {
                transform: translateY(0);
            }

        .botones-laterales .btn-success {
            background-color: #28a745;
        }

            .botones-laterales .btn-success:hover {
                background-color: #218838 !important;
            }

        .botones-laterales .btn-danger {
            background-color: #dc3545;
        }

            .botones-laterales .btn-danger:hover {
                background-color: #c82333 !important;
            }

    .tabla-congelada thead th {
        position: sticky;
        top: 0;
        z-index: 10;
        background-color: #0d6efd;
        color: white;
    }

    /* Legend del groupbox alineada a la derecha */
    .groupbox-filtro legend {
        font-size: 15px;
        font-weight: 600;
        color: #0d6efd;
        width: auto;
        padding: 0 6px;
        margin-left: auto; /* ← Empuja la leyenda a la derecha */
        margin-right: 10px; /* Espacio desde el borde derecho */
    }

    /* Botón Buscar dentro del groupbox con estilo idéntico a los botones principales */
    #btnBuscarFiltro {
        background-color: #007bff !important;
        color: white !important;
        border: none;
        border-radius: 8px;
        padding: 8px 12px;
        font-weight: 600;
        height: 38px;
        min-width: 100px;
        transition: all 0.3s ease;
    }

        #btnBuscarFiltro:hover {
            background-color: #0056b3 !important;
            transform: translateY(-3px) !important;
            box-shadow: 0 8px 15px rgba(0,0,0,0.2) !important;
        }

        #btnBuscarFiltro:active {
            transform: translateY(0);
        }

    /* Reemplaza tu #empleadoSelect actual por este */
    #empleadoSelect {
        width: 100% !important;
        height: 38px !important; /* Altura fija obligatoria */
        padding: 6px 30px 6px 8px;
        border: 1px solid #ccc;
        border-radius: 6px;
        background-color: white;
        text-align-last: center;
        box-sizing: border-box;
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath fill='%23333' d='M1.5 0L6 4.5L10.5 0L12 1.5L6 7.5L0 1.5L1.5 0Z'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 10px center;
        background-size: 12px;
    }

        /* Agrega esto para limpiar las opciones internas */
        #empleadoSelect option {
            background-color: white;
            color: #333;
            padding: 8px;
            text-align: center;
        }

    select.form-control {
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath fill='%23333' d='M1.5 0L6 4.5L10.5 0L12 1.5L6 7.5L0 1.5L1.5 0Z'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 10px center;
        background-size: 12px;
    }

        /* 2. El select en sí: ocupa 100% del contenedor y no se expande */
        .campos-centrados > .campo:first-child #empleadoSelect {
            width: 100% !important;
            max-width: 100% !important;
        }

    .campos-centrados > .campo:first-child {
        flex: 0 0 250px;
        min-width: 250px;
        max-width: 250px;
    }

    /* Quitar outline y borde por defecto en TODOS los botones */
    button {
        outline: none !important;
    }

</style>

<div class="container-fluid d-flex justify-content-center align-items-center"; padding: 0;">
    <div class="card shadow-lg p-4 card-principal">
        <h2 class="text-center mb-4 fw-bold text-primary">VACACIONES DE EMPLEADOS</h2>
        <div class="row">
            <!-- Panel izquierdo -->
            <div class="col-md-2 d-flex flex-column align-items-start">
                <div id="logoContainer">
                    <img src="/images/file_0000000079e461fd8636559665695d530001.png" alt="Logo" id="farmaciaLogo" />
                </div>
                @* Cuenta *@
                <a href="/Actualizar/ActualizarCuenta?idProveedor=@idProv&vista=@vistaActual"
                   class="btn btn-primary">Cuenta</a>

                @* Boletas - AQUÍ ESTABA EL ERROR: Usamos idProveedorSeleccionado y vista *@
                <a href="/Proveedores/IngresarProveedor?idProveedorSeleccionado=@idProv&vista=@vistaActual"
                   class="btn btn-primary">Boletas</a>

                @* Cuentas de Clientes *@
                <a href="/CuentaCliente/Index?idProveedor=@idProv&vistaOrigen=@vistaActual"
                   class="btn btn-primary">Cuentas de Clientes</a>

                @* Inasistencia *@
                <a href="/Proveedores/Inasistencia?origen=@vistaActual&idProveedor=@idProv"
                   class="btn btn-primary">Inasistencia</a>

                @* Vacaciones (Activo) *@
                <a href="/Vacaciones/Index?idProveedor=@idProv&vista=@vistaActual"
                   class="btn btn-primary">Vacaciones</a>

                @* Volver al Index de Proveedores (usa la lista de origen) *@
                <a href="/Proveedores/Index?vista=@vistaActual" class="btn btn-primary">Volver</a>
            </div>

            <div class="col-md-10 d-flex justify-content-start">
                <div class="bloque-principal">
                    @if (TempData["MensajeExito"] != null)
                    {
                        <div class="alert alert-success alert-dismissible fade show" role="alert">
                            @TempData["MensajeExito"]
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                    }

                    <!-- Groupbox de filtros -->
                    <div class="groupbox-filtro @claseVisualDisabled">
                        <legend>Filtros</legend>
                        <div class="filtro-busqueda">
                            <div class="campo daterange-container">
                                <label for="btnAbrirCalendario">Rango de Fechas</label>
                                <button type="button" id="btnAbrirCalendario" class="btn btn-outline-primary shadow-sm" style="height: 38px; width: 100%;">
                                    dd/mm/yyyy - dd/mm/yyyy
                                </button>
                            </div>
                        </div>
                        <!-- Fila de Buscar Empleado + Botón Buscar (al lado derecho) -->
                        <div class="filtro-busqueda" style="margin-top: 15px; display: flex; align-items: end; gap: 10px;">
                            <div class="campo" style="flex: 1;">
                                <label for="buscarEmpleadoInput">Buscar Empleado</label>
                                <input type="text" id="buscarEmpleadoInput" class="form-control shadow-sm" placeholder="Escriba aquí..." style="text-align: left;" />
                            </div>
                            <div class="campo" style="align-self: end;">
                                <button id="btnBuscarFiltro">Buscar</button>
                            </div>
                        </div>
                    </div>

                    <!-- CAMPOS PARA AGREGAR VACACIÓN (arriba de la tabla) -->
                    <!-- CAMPOS PARA AGREGAR VACACIÓN (dos filas) -->
                    <!-- CAMPOS PARA AGREGAR VACACIÓN (dos filas, alineados perfectamente) -->
                    <!-- CAMPOS PARA AGREGAR VACACIÓN (dos filas, alineados perfectamente) -->
                    <div class="@claseVisualDisabled">
                        <!-- Fila 1: Empleado y Días -->
                        <div class="campos-centrados" style="margin-bottom: 10px !important;">
                            <div class="campo" style="flex: 0 0 250px;">
                                <label for="empleadoSelect">Empleado</label>
                                <select id="empleadoSelect" class="form-control shadow-sm">
                                    <option value="">Seleccione Empleado</option>
                                    @if (ViewBag.Empleados != null)
                                    {
                                        foreach (var emp in ViewBag.Empleados)
                                        {
                                            <option value="@emp.Idusuario" data-nombre="@emp.NombreCompleto">
                                                @emp.NombreCompleto - DNI: @emp.Dni
                                            </option>
                                        }
                                    }
                                </select>
                            </div>
                            <div class="campo" style="flex: 0 0 150px; max-width: 150px;">
                                <label for="diasInput">Días Solicitados</label>
                                <input type="number" id="diasInput" class="form-control shadow-sm" min="1" max="60" value="15" />
                            </div>
                        </div>
                        <!-- Fila 2: Fecha Inicio y Fecha Fin -->
                        <!-- Período (mismo estilo que el filtro) -->
                        <div class="campos-centrados" style="margin-top: 15px; margin-bottom: 10px !important;">
                            <div class="campo" style="flex: 0 0 400px; max-width: 400px;">
                                <label for="btnPeriodo">Período de Vacaciones</label>
                                <button type="button" id="btnPeriodo" class="btn btn-outline-primary shadow-sm w-100" style="height: 38px;">
                                    dd/mm/yyyy - dd/mm/yyyy
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Tabla y botones -->
                    <div class="contenedor-tablas-botones mt-3">
                        <div class="table-wrapper">
                            <div class="tabla-encabezado">REGISTROS DE VACACIONES</div>
                            <div class="table-responsive">
                                <table class="table table-bordered table-hover align-middle tabla-congelada" id="tablaVacaciones">
                                    <thead class="table-primary">
                                        <tr>
                                            <th>Empleado</th>
                                            <th>Días</th>
                                            <th>Período</th> <!-- Nueva columna única -->
                                            <th>Días Favor</th>
                                            <th><input type="checkbox" id="checkAll" class="form-check-input" /></th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var v in Model)
                                        {
                                            <tr data-vacacion-id="@v.IdVacaciones">
                                                <td>@(v.NombreEmpleadoRegistrado ?? "Sin nombre")</td>
                                                <td class="text-center">@v.DiasVacaciones</td>
                                                <td class="text-center">
                                                    @v.FechaInicio.ToString("dd/MM/yyyy") - @v.FechaFin.ToString("dd/MM/yyyy")
                                                </td>
                                                <td class="text-center">@Math.Abs(v.DiasFavor)</td>
                                                <td><input type="checkbox" class="form-check-input fila-check" /></td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <div class="botones-laterales @claseVisualDisabled">
                            <button id="btnAgregar">Agregar</button>
                            <button id="btnGuardar">Guardar</button>
                            <button id="btnNuevoRegistro">Nuevo Registro</button>
                            <button id="btnEliminar">Eliminar</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


@section Scripts {
    <!-- Librerías -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/locale/es.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css" />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/exceljs/dist/exceljs.min.js"></script>

    <script>
         // Calendarios con jQuery
       $(document).ready(function () {
            // Calendario FILTROS
            $('#btnAbrirCalendario').daterangepicker({
                autoUpdateInput: false,
                opens: 'left',
                locale: {
                    format: 'DD/MM/YYYY',
                    applyLabel: 'Aplicar',
                    cancelLabel: 'Limpiar',
                    daysOfWeek: ['Do', 'Lu', 'Ma', 'Mi', 'Ju', 'Vi', 'Sa'],
                    monthNames: ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre']
                }
            });

            $('#btnAbrirCalendario').on('apply.daterangepicker', function(ev, picker) {
                $(this).text(picker.startDate.format('DD/MM/YYYY') + ' - ' + picker.endDate.format('DD/MM/YYYY'));
            });
            $('#btnAbrirCalendario').on('cancel.daterangepicker', function(ev, picker) {
                $(this).text('dd/mm/yyyy - dd/mm/yyyy');
            });

            // Calendario PERÍODO
            $('#btnPeriodo').daterangepicker({
                autoUpdateInput: false,
                opens: 'left',
                locale: {
                    format: 'DD/MM/YYYY',
                    applyLabel: 'Aplicar',
                    cancelLabel: 'Limpiar',
                    daysOfWeek: ['Do', 'Lu', 'Ma', 'Mi', 'Ju', 'Vi', 'Sa'],
                    monthNames: ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre']
                }
            });

            $('#btnPeriodo').on('apply.daterangepicker', function(ev, picker) {
                $(this).text(picker.startDate.format('DD/MM/YYYY') + ' - ' + picker.endDate.format('DD/MM/YYYY'));
            });
            $('#btnPeriodo').on('cancel.daterangepicker', function(ev, picker) {
                $(this).text('dd/mm/yyyy - dd/mm/yyyy');
            });

            // FIX: Apertura forzada y estable
            $('#btnAbrirCalendario, #btnPeriodo').on('click', function(e) {
                e.preventDefault();
                e.stopPropagation(); // Crucial: evita que el click se propague y cierre el picker
                const picker = $(this).data('daterangepicker');
                if (picker) {
                    picker.show();
                }
            });

            // Extra: Mantener abierto al volver a la pestaña
            $(window).on('focus', function () {
                if ($('#btnAbrirCalendario').data('daterangepicker')?.element.is(':focus') ||
                    $('#btnPeriodo').data('daterangepicker')?.element.is(':focus')) {
                    $('#btnAbrirCalendario, #btnPeriodo').each(function () {
                        $(this).data('daterangepicker')?.show();
                    });
                }
            });
        });

        // Lógica de la tabla (queda igual, ya funciona)
        document.addEventListener('DOMContentLoaded', function () {
            const TABLA_ID = "tablaVacaciones";
            const MIN_FILAS_VISIBLE = 5;

            function agregarFilasVacias() {
                const tbody = document.querySelector(`#${TABLA_ID} tbody`);
                if (!tbody) return;
                document.querySelectorAll('tr.fila-relleno').forEach(f => f.remove());
                const filasConDatos = document.querySelectorAll('tr[data-vacacion-id]').length;
                const filasNecesarias = Math.max(0, MIN_FILAS_VISIBLE - filasConDatos);
                for (let i = 0; i < filasNecesarias; i++) {
                    const filaVacia = document.createElement('tr');
                    filaVacia.classList.add('fila-relleno');
                    filaVacia.innerHTML = `
                        <td>&nbsp;</td>
                        <td class="text-center">&nbsp;</td>
                        <td class="text-center">&nbsp;</td>
                        <td class="text-center">&nbsp;</td>
                        <td><input type="checkbox" class="form-check-input fila-check" disabled /></td>
                    `;
                    tbody.appendChild(filaVacia);
                }
            }

            agregarFilasVacias();

            // Buscar Filtro
                    // Buscar Filtro
                // Buscar Filtro
        document.getElementById('btnBuscarFiltro').addEventListener('click', async function () {
            const nombre = document.getElementById('buscarEmpleadoInput').value.trim();
            const rangoBtn = document.getElementById('btnAbrirCalendario');
            const rangoTexto = rangoBtn.textContent.trim();

            let fechaDesde = null;
            let fechaHasta = null;

            if (rangoTexto !== 'dd/mm/yyyy - dd/mm/yyyy') {
                const [desde, hasta] = rangoTexto.split(' - ');
                try {
                    fechaDesde = desde.split('/').reverse().join('-'); // yyyy-MM-dd
                    fechaHasta = hasta.split('/').reverse().join('-');
                } catch (e) {
                    Swal.fire('Error', 'Formato de fecha inválido', 'error');
                    return;
                }
            }

            const hayNombre = nombre !== '';
            const hayRango = fechaDesde !== null && fechaHasta !== null;

            if (!hayNombre && !hayRango) {
                Swal.fire({
                    title: 'Atención',
                    text: 'Ingrese al menos un filtro (nombre o rango de fechas)',
                    confirmButtonText: 'Entendido',
                     confirmButtonColor: '#007bff'
                });
                return;
            }

            try {
                let url = '/Vacaciones/BuscarVacaciones?';
                if (hayNombre) url += `nombreEmpleado=${encodeURIComponent(nombre)}&`;
                if (hayRango) {
                    url += `fechaDesde=${encodeURIComponent(fechaDesde)}&fechaHasta=${encodeURIComponent(fechaHasta)}`;
                }

                const response = await fetch(url);
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Error ${response.status}: ${errorText}`);
                }

                const data = await response.json();

                        if (!Array.isArray(data)) {
            throw new Error(data.message || 'El servidor devolvió un formato inesperado.');
        }

                const tbody = document.querySelector('#tablaVacaciones tbody');
                tbody.innerHTML = ''; // Limpiamos

                data.forEach(v => {
                    const fila = document.createElement('tr');
                    fila.setAttribute('data-vacacion-id', v.idVacaciones);
                    fila.innerHTML = `
                        <td>${v.nombreEmpleado || ''}</td>
                        <td class="text-center">${v.diasVacaciones}</td>
                        <td class="text-center">${v.fechaInicio} - ${v.fechaFin}</td>
                        <td class="text-center">${v.diasFavor}</td>
                        <td><input type="checkbox" class="form-check-input fila-check" /></td>
                    `;
                    tbody.appendChild(fila);
                });

                agregarFilasVacias();

                if (data.length > 0) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Búsqueda exitosa',
                        text: `Se encontraron ${data.length} registro${data.length === 1 ? '' : 's'}.`,
                        timer: 2500,
                        showConfirmButton: false
                    });
                } else {
                    Swal.fire({
                        title: 'Sin resultados',
                        text: 'No se encontraron vacaciones con esos filtros.',
                        confirmButtonText: 'Entendido',
                         confirmButtonColor: '#007bff'
                    });
                }
            } catch (err) {
                console.error('Error en búsqueda:', err);
                Swal.fire({
                    title: 'Error',
                    text: err.message || 'No se pudo realizar la búsqueda. Intente nuevamente.',
                     confirmButtonText: 'Entendido',
                      confirmButtonColor: '#007bff'
                });
            }
        });

                document.getElementById('btnAgregar').addEventListener('click', async function () {
        const elEmpleado = document.getElementById('empleadoSelect');
        const elDias = document.getElementById('diasInput');
        const btnPeriodo = document.getElementById('btnPeriodo');

        if (!elEmpleado || !elDias || !btnPeriodo) {
            Swal.fire('Error', 'No se encontraron los campos necesarios.', 'error');
            return;
        }

        const empleadoId = elEmpleado.value?.trim() || '';
        // ←←← Cambio aquí: usamos data-nombre para obtener solo el nombre limpio
        const empleadoNombre = elEmpleado.options[elEmpleado.selectedIndex]?.getAttribute('data-nombre') || '';
        const diasVal = parseInt(elDias.value) || 0;
        const periodoTexto = btnPeriodo.textContent.trim();

        // Validaciones (igual)
        if (!empleadoId || empleadoId === '') {
            Swal.fire('Error', 'Seleccione un empleado', 'error');
            return;
        }
        if (diasVal < 1) {
            Swal.fire('Error', 'Ingrese días solicitados (mínimo 1)', 'error');
            return;
        }
        if (periodoTexto === 'dd/mm/yyyy - dd/mm/yyyy') {
            Swal.fire('Error', 'Seleccione el período de vacaciones', 'error');
            return;
        }

        const [desde, hasta] = periodoTexto.split(' - ');
        const inicioDate = new Date(desde.split('/').reverse().join('-'));
        const finDate = new Date(hasta.split('/').reverse().join('-'));

        if (finDate < inicioDate) {
            Swal.fire('Error', 'La fecha fin no puede ser anterior al inicio', 'error');
            return;
        }

        const datos = {
            Idusuario: parseInt(empleadoId),
            DiasVacaciones: diasVal,
            FechaInicio: inicioDate.toISOString(),
            FechaFin: finDate.toISOString(),
            NombreEmpleadoFrontend: empleadoNombre  // ← Ahora solo el nombre limpio
        };

            try {
                const response = await fetch('/Vacaciones/ApiCreate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''
                    },
                    body: JSON.stringify(datos)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Error ${response.status}: ${errorText}`);
                }

                const result = await response.json();

                if (result.success) {
                    // Calculamos días reales y favor usando las fechas originales (locales)
                    const dInicio = new Date(inicioDate);
                    const dFin = new Date(finDate);
                    const dReales = Math.floor((dFin - dInicio) / 86400000) + 1;
                    const dFavor = Math.abs(diasVal - dReales);

                    const tbody = document.querySelector('#tablaVacaciones tbody');
                    const nuevaFila = document.createElement('tr');
                    nuevaFila.setAttribute('data-vacacion-id', result.id);
                    nuevaFila.innerHTML = `
                        <td class="empleado-clickable">${empleadoNombre || v.nombreEmpleado || ''}</td>
                        <td class="text-center">${diasVal}</td>
                        <td class="text-center">${desde} - ${hasta}</td>
                        <td class="text-center">${dFavor}</td>
                        <td><input type="checkbox" class="form-check-input fila-check" /></td>
                    `;
                    tbody.insertBefore(nuevaFila, tbody.firstChild);

                    elEmpleado.value = '';
                    elDias.value = '15';
                    btnPeriodo.textContent = 'dd/mm/yyyy - dd/mm/yyyy';
                    agregarFilasVacias();

                    Swal.fire({
                        icon: 'success',
                        title: '¡Agregado!',
                        text: 'Vacación registrada correctamente',
                        timer: 1800,
                        showConfirmButton: false
                    });
                } else {
                    Swal.fire('Error', result.message || 'No se pudo guardar', 'error');
                }
            } catch (err) {
                console.error('Error en ApiCreate:', err);
                Swal.fire('Error', 'No se pudo conectar con el servidor. Verifica tu conexión o intenta más tarde.', 'error');
            }
        });

            // btnNuevoRegistro
            document.getElementById('btnNuevoRegistro').addEventListener('click', function () {
                const tbody = document.querySelector(`#${TABLA_ID} tbody`);
                tbody.innerHTML = '';
                agregarFilasVacias();
                Swal.fire({
                    icon: 'success',
                    title: 'Tabla limpiada',
                    text: 'Puede comenzar un nuevo registro.',
                    timer: 2500,
                    showConfirmButton: false
                });
            });

            // btnEliminar
            document.getElementById('btnEliminar').addEventListener('click', async function () {
                const checkboxes = document.querySelectorAll(`#${TABLA_ID} .fila-check:checked`);
                if (checkboxes.length === 0) {
                    Swal.fire({
                        title: 'Atención',
                        text: 'Debe seleccionar al menos un registro para eliminar.',
                        confirmButtonText: 'Entendido',
                        confirmButtonColor: '#007bff'
                    });
                    return;
                }
                const result = await Swal.fire({
                    title: 'Confirmar eliminación',
                    text: `Se eliminarán ${checkboxes.length} registro(s) de vacaciones.`,
                    showCancelButton: true,
                    confirmButtonText: 'Sí, eliminar',
                    cancelButtonText: 'Cancelar',
                    confirmButtonColor: '#007bff',
                    cancelButtonColor: '#007bff'
                });
                if (!result.isConfirmed) return;
                let eliminados = 0;
                for (const chk of checkboxes) {
                    const tr = chk.closest('tr');
                    const id = tr.getAttribute('data-vacacion-id');
                    if (id && parseInt(id) > 0) {
                        try {
                            const resp = await fetch(`/Vacaciones/EliminarVacacion?id=${id}`, { method: 'DELETE' });
                            const data = await resp.json();
                            if (data.success) {
                                tr.remove();
                                eliminados++;
                            }
                        } catch (err) {
                            console.error(err);
                        }
                    } else {
                        tr.remove();
                        eliminados++;
                    }
                }
                agregarFilasVacias();
                Swal.fire({
                    title: '¡Eliminado!',
                    text: `${eliminados} registro(s) eliminados correctamente.`,
                    icon: 'success',
                    confirmButtonText: 'Entendido',
                    confirmButtonColor: '#007bff'
                });
            });

            // btnGuardar
            document.getElementById('btnGuardar').addEventListener('click', async function () {
                const filas = document.querySelectorAll(`#${TABLA_ID} tbody tr[data-vacacion-id]:not([data-vacacion-id='0'])`);
                if (filas.length === 0) {
                    Swal.fire({
                        title: 'Sin datos',
                        text: 'No hay registros para exportar.',
                        confirmButtonText: 'Entendido',
                        confirmButtonColor: '#007bff'
                    });
                    return;
                }
                const datos = [];
                filas.forEach(f => {
                    const celdas = f.querySelectorAll('td');
                    datos.push([
                        celdas[0].innerText.trim(),
                        celdas[1].innerText.trim(),
                        celdas[2].innerText.trim(),
                        celdas[3].innerText.trim()
                    ]);
                });
                const now = new Date();
                const datePart = now.toLocaleDateString('es-ES', { year: 'numeric', month: '2-digit', day: '2-digit' }).replace(/\//g, '-');
                const timePart = now.getHours().toString().padStart(2, '0') + '∶' + now.getMinutes().toString().padStart(2, '0');
                const fileName = `Registro Vacaciones ${datePart} ${timePart}.xlsx`;
                const workbook = new ExcelJS.Workbook();
                const sheet = workbook.addWorksheet('VACACIONES');
                sheet.addRow(['REGISTRO DE VACACIONES']);
                sheet.mergeCells('A1:E1');
                const titleCell = sheet.getCell('A1');
                titleCell.font = { size: 14, bold: true };
                titleCell.alignment = { horizontal: 'center' };
                const headers = ['EMPLEADO', 'DÍAS', 'PERÍODO', 'DÍAS FAVOR'];
                sheet.addRow(headers);
                const headerRow = sheet.lastRow;
                headerRow.eachCell(cell => {
                    cell.font = { bold: true, color: { argb: 'FF000000' } };
                    cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFFFC080' } };
                    cell.alignment = { horizontal: 'center', vertical: 'middle' };
                    cell.border = {
                        top: { style: 'thin' },
                        left: { style: 'thin' },
                        bottom: { style: 'thin' },
                        right: { style: 'thin' }
                    };
                });
                datos.forEach((row, i) => {
                    sheet.addRow(row);
                    const dataRow = sheet.lastRow;
                    dataRow.eachCell(cell => {
                        cell.alignment = { horizontal: 'center', vertical: 'middle' };
                        cell.fill = {
                            type: 'pattern',
                            pattern: 'solid',
                            fgColor: { argb: i % 2 === 0 ? 'FFDDEEFF' : 'FFCCFFFF' }
                        };
                        cell.border = {
                            top: { style: 'thin' },
                            left: { style: 'thin' },
                            bottom: { style: 'thin' },
                            right: { style: 'thin' }
                        };
                    });
                });
                sheet.columns = [
                    { width: 28 }, { width: 10 }, { width: 35 }, { width: 15 }
                ];
                const buffer = await workbook.xlsx.writeBuffer();
                const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = fileName;
                link.click();
            });

            // Selección de filas y check all
            document.querySelector(`#${TABLA_ID} tbody`).addEventListener('click', function (e) {
                const fila = e.target.closest('tr');
                if (!fila || !fila.hasAttribute('data-vacacion-id')) return;
                const checkbox = fila.querySelector('.fila-check');
                if (checkbox) {
                    if (e.target !== checkbox) checkbox.checked = !checkbox.checked;
                    fila.classList.toggle('fila-seleccionada', checkbox.checked);
                }
                const checkAll = document.getElementById('checkAll');
                const totalFilas = document.querySelectorAll(`#${TABLA_ID} tbody tr[data-vacacion-id]`).length;
                const marcadas = document.querySelectorAll(`#${TABLA_ID} tbody tr[data-vacacion-id] .fila-check:checked`).length;
                checkAll.checked = marcadas > 0 && marcadas === totalFilas;
            });

            document.getElementById('checkAll').addEventListener('change', function () {
                const checked = this.checked;
                document.querySelectorAll(`#${TABLA_ID} tbody tr[data-vacacion-id] .fila-check`).forEach(chk => {
                    chk.checked = checked;
                    chk.closest('tr').classList.toggle('fila-seleccionada', checked);
                });
            });
                    // Al hacer click en el nombre del empleado en la tabla
        document.querySelector('#tablaVacaciones tbody').addEventListener('click', function (e) {
            const td = e.target.closest('td');
            if (!td || td.cellIndex !== 0) return; // Solo columna Empleado

            const nombreCompleto = td.innerText.trim();
            if (!nombreCompleto || nombreCompleto === 'Sin nombre') return;

            fetch(`/Vacaciones/GetDatosEmpleado?nombre=${encodeURIComponent(nombreCompleto)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                                        Swal.fire({
            title: data.nombreCompleto,
            html: `
                <div class="text-center mt-3">
                    <p class="mb-2"><strong>DNI:</strong> ${data.dni || 'No disponible'}</p>
                    <p class="mb-2"><strong>Teléfono:</strong> ${data.telefono || 'No disponible'}</p>
                    <p class="mb-3"><strong>Dirección:</strong> ${data.direccion || 'No disponible'}</p>
                </div>
            `,
            icon: 'info',
            confirmButtonText: 'Entendido',
            confirmButtonColor: '#007bff',
            customClass: {
                popup: 'border border-primary shadow-lg rounded-3',  // borde azul y sombra
                title: 'fs-4 fw-bold text-primary mb-4',             // título grande y azul
                htmlContainer: 'text-center fs-5'                     // centrado
            }
        });
                    } else {
                        Swal.fire('No encontrado', data.message || 'No se encontraron datos', 'warning');
                    }
                })
                .catch(() => {
                    Swal.fire('Error', 'No se pudo cargar los datos del empleado', 'error');
                });
        });
        });
    </script>
}